%File: formatting-instructions-latex-2024.tex
%release 2024.0
\documentclass[letterpaper]{article} % DO NOT CHANGE THIS
\usepackage{aaai24}  % DO NOT CHANGE THIS
\usepackage{times}  % DO NOT CHANGE THIS
\usepackage{helvet}  % DO NOT CHANGE THIS
\usepackage{courier}  % DO NOT CHANGE THIS
\usepackage[hyphens]{url}  % DO NOT CHANGE THIS
\usepackage{graphicx} % DO NOT CHANGE THIS
\urlstyle{rm} % DO NOT CHANGE THIS
\def\UrlFont{\rm}  % DO NOT CHANGE THIS
\usepackage{natbib}  % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\usepackage{caption} % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\frenchspacing  % DO NOT CHANGE THIS
\setlength{\pdfpagewidth}{8.5in}  % DO NOT CHANGE THIS
\setlength{\pdfpageheight}{11in}  % DO NOT CHANGE THIS
%
% These are recommended to typeset algorithms but not required. See the subsubsection on algorithms. Remove them if you don't have algorithms in your paper.
\usepackage{algorithm}
\usepackage{algorithmic}

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{booktabs}
% \urlstyle{same}

\usepackage{amsfonts}
\usepackage{mathtools}
% \usepackage[noend]{algpseudocode}
\usepackage{subcaption}
\usepackage{gensymb}
\usepackage{pgfplots}
% \usepackage{bbm}
\usepackage{comment}
% \usepackage{xr}
\usepackage{mathrsfs}

\newtheorem{example}{Example}
\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}
\newtheorem{corollary}{Corollary}
\newtheorem{lemma}{Lemma}
\newtheorem{remark}{Remark}



\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

%
% These are are recommended to typeset listings but not required. See the subsubsection on listing. Remove this block if you don't have listings in your paper.
\usepackage{newfloat}
\usepackage{listings}
\DeclareCaptionStyle{ruled}{labelfont=normalfont,labelsep=colon,strut=off} % DO NOT CHANGE THIS
\lstset{%
	basicstyle={\footnotesize\ttfamily},% footnotesize acceptable for monospace
	numbers=left,numberstyle=\footnotesize,xleftmargin=2em,% show line numbers, remove this entire line if you don't want the numbers.
	aboveskip=0pt,belowskip=0pt,%
	showstringspaces=false,tabsize=2,breaklines=true}
\floatstyle{ruled}
\newfloat{listing}{tb}{lst}{}
\floatname{listing}{Listing}
%
% Keep the \pdfinfo as shown here. There's no need
% for you to add the /Title and /Author tags.

% DISALLOWED PACKAGES
% \usepackage{authblk} -- This package is specifically forbidden
% \usepackage{balance} -- This package is specifically forbidden
% \usepackage{color (if used in text)
% \usepackage{CJK} -- This package is specifically forbidden
% \usepackage{float} -- This package is specifically forbidden
% \usepackage{flushend} -- This package is specifically forbidden
% \usepackage{fontenc} -- This package is specifically forbidden
% \usepackage{fullpage} -- This package is specifically forbidden
% \usepackage{geometry} -- This package is specifically forbidden
% \usepackage{grffile} -- This package is specifically forbidden
% \usepackage{hyperref} -- This package is specifically forbidden
% \usepackage{navigator} -- This package is specifically forbidden
% (or any other package that embeds links such as navigator or hyperref)
% \indentfirst} -- This package is specifically forbidden
% \layout} -- This package is specifically forbidden
% \multicol} -- This package is specifically forbidden
% \nameref} -- This package is specifically forbidden
% \usepackage{savetrees} -- This package is specifically forbidden
% \usepackage{setspace} -- This package is specifically forbidden
% \usepackage{stfloats} -- This package is specifically forbidden
% \usepackage{tabu} -- This package is specifically forbidden
% \usepackage{titlesec} -- This package is specifically forbidden
% \usepackage{tocbibind} -- This package is specifically forbidden
% \usepackage{ulem} -- This package is specifically forbidden
% \usepackage{wrapfig} -- This package is specifically forbidden
% DISALLOWED COMMANDS
% \nocopyright -- Your paper will not be published if you use this command
% \addtolength -- This command may not be used
% \balance -- This command may not be used
% \baselinestretch -- Your paper will not be published if you use this command
% \clearpage -- No page breaks of any kind may be used for the final version of your paper
% \columnsep -- This command may not be used
% \newpage -- No page breaks of any kind may be used for the final version of your paper
% \pagebreak -- No page breaks of any kind may be used for the final version of your paperr
% \pagestyle -- This command may not be used
% \tiny -- This is not an acceptable font size.
% \vspace{- -- No negative value may be used in proximity of a caption, figure, table, section, subsection, subsubsection, or reference
% \vskip{- -- No negative value may be used to alter spacing above or below a caption, figure, table, section, subsection, subsubsection, or reference

\setcounter{secnumdepth}{0} %May be changed to 1 or 2 if section numbers are desired.

% The file aaai24.sty is the style file for AAAI Press
% proceedings, working notes, and technical reports.
%

% Title

% Your title must be in mixed case, not sentence case.
% That means all verbs (including short verbs like be, is, using,and go),
% nouns, adverbs, adjectives should be capitalized, including both words in hyphenated terms, while
% articles, conjunctions, and prepositions are lower case unless they
% directly follow a colon or long dash
\title{Optimality and Proportionality in Online Friends Partitioning under Uncertainty}
\author{Paper ID \# 1884}
% \author{
%     %Authors
%     % All authors must be in the same font size and format.
%     Written by AAAI Press Staff\textsuperscript{\rm 1}\thanks{With help from the AAAI Publications Committee.}\\
%     AAAI Style Contributions by Pater Patel Schneider,
%     Sunil Issar,\\
%     J. Scott Penberthy,
%     George Ferguson,
%     Hans Guesgen,
%     Francisco Cruz\equalcontrib,
%     Marc Pujol-Gonzalez\equalcontrib
% }
% \affiliations{
%     %Afiliations
%     \textsuperscript{\rm 1}Association for the Advancement of Artificial Intelligence\\
%     % If you have multiple authors and multiple affiliations
%     % use superscripts in text and roman font to identify them.
%     % For example,

%     % Sunil Issar\textsuperscript{\rm 2},
%     % J. Scott Penberthy\textsuperscript{\rm 3},
%     % George Ferguson\textsuperscript{\rm 4},
%     % Hans Guesgen\textsuperscript{\rm 5}
%     % Note that the comma should be placed after the superscript

%     1900 Embarcadero Road, Suite 101\\
%     Palo Alto, California 94303-3310 USA\\
%     % email address must be in roman text type, not monospace or sans serif
%     proceedings-questions@aaai.org
% %
% % See more examples next
% }

% %Example, Single Author, ->> remove \iffalse,\fi and place them surrounding AAAI title to use it
% \iffalse
% \title{My Publication Title --- Single Author}
% \author {
%     Author Name
% }
% \affiliations{
%     Affiliation\\
%     Affiliation Line 2\\
%     name@example.com
% }
% \fi

% \iffalse
% %Example, Multiple Authors, ->> remove \iffalse,\fi and place them surrounding AAAI title to use it
% \title{My Publication Title --- Multiple Authors}
% \author {
%     % Authors
%     First Author Name\textsuperscript{\rm 1,\rm 2},
%     Second Author Name\textsuperscript{\rm 2},
%     Third Author Name\textsuperscript{\rm 1}
% }
% \affiliations {
%     % Affiliations
%     \textsuperscript{\rm 1}Affiliation 1\\
%     \textsuperscript{\rm 2}Affiliation 2\\
%     firstAuthor@affiliation1.com, secondAuthor@affilation2.com, thirdAuthor@affiliation1.com
% }
% \fi


% REMOVE THIS: bibentry
% This is only needed to show inline citations in the guidelines document. You should not need it and can safely delete it.
\usepackage{bibentry}
% END REMOVE bibentry

\begin{document}

\maketitle

\begin{abstract}
    We study the \textit{friendship-based online coalition formation} problem, in which agents that appear one at a time should be partitioned into coalitions, and an agent's utility for a coalition is the number of her neighbors (i.e., \textit{friends}) within the coalition. Unlike prior work, agents' friendships may be \textit{uncertain}. We analyze the desirability of the resulting partition in the common term of \textit{optimality}, aiming to maximize the social welfare, and the novel \textit{proportionality} criterion, aiming to proportionally reflect agents' friendships in the resulting partition. For optimizing social welfare, we first design an online algorithm termed \textit{Maximum Predicted Coalitional Friends} (MPCF), which is enhanced with predictions of each agent's number of friends within any possible coalition. For common classes of random graphs, we prove that MPCF is optimal, and, for certain graphs, provides the \textit{same} guarantee as the best known competitive algorithm for settings \textit{without} uncertainty. %When an agent's utility is instead the \textit{fraction} of her friends in the coalition and there is no uncertainty, we devise an algorithm with access to predictions of agents' preferences that, under mild conditions, achieves an asymptotic competitive ratio of at least $3.324$. This improves the optimal known lower bound of $4$ for algorithms \textit{without} predictions.
    We then introduce the notion of \textit{proportionality} from multi-winner elections into hedonic games by devising \textit{coalitional} variants of \textit{Proportional Justified Representation} and \textit{Extended Justified Representation} called \textit{CPJR} and \textit{CEJR} (resp.). We prove a strong positive result for the case of uncertainty: \textit{For a natural random graph model, MPCF is optimal in terms of both social welfare as well as guaranteeing CPJR and CEJR}. When friendships are \textit{certain} this is not necessarily the case, but we show that CPJR can be easily attained under mild assumptions, while CEJR can be approximated.
\end{abstract}

\section{Introduction}
\label{sec:intro}
Your employers have reserved the best banquet venue of the city for a company event. When you arrive, you see multiple tables of various capacities that have been set to accommodate the participants, yet some seats are already taken. You would like to share your table with some friends from work, while avoiding colleagues you do not like that much. As such, your managers would like to ensure that each employee is assigned to a table with as many of his friends as possible, so he would have a good experience during the event. In each table, the organizers also desire that every sufficiently large group of participants with similar preferences would have common friends in a manner proportional to their size. A similar scenario was considered by Bil{\`o}, Monaco, and Moscardell \shortcite{bilo2022hedonic}. Additional real-life examples include academic research \cite{alcalde2004researching} and international unions \cite{hosli2001coalition}, where \textit{agents} perform activities in \textit{coalitions} rather than on their own. Such situations fall within the phenomenon of coalition formation, which is noticed in our social, economic, and politic life.
%

In this paper, we introduce and study a model capturing such real-life scenarios. A popular framework for studying coalition formation is that of \textit{hedonic games} \cite{dreze1980hedonic}, which disregards externalities, i.e., agents’ utilities solely depend on the coalition they are part of. The outcome of such games is a set of disjoint coalitions (hereafter, \textit{partition}). In our model, agents' friendships may be encoded by an unweighted and undirected graph and an agent's utility for a coalition is the number of her neighbors (i.e., \textit{friends}) within the coalition, that is, the agent's \textit{degree} in the graph induced by the coalition. %This constitutes the thoroughly researched class of \textit{additively separable hedonic games} (ASHGs) \cite{bogomolnaia2002stability}.
As in our example, there are many contexts where it is more realistic to assume that coalitions may have a limited \textit{physical} space and agents arrive over time. Therefore, we assume an upper bound on the size of each coalition. Then, a central authority (i.e., an \textit{online} algorithm) has to \textit{immediately} and \textit{irrevocably} decide whether to add an arriving agent into an existing coalition or to create a new one containing, at this moment, only her.

% However, the number of coalitions an agent can be part of is exponential in the number of agents. Thus, it is desirable to consider expressive, but succinctly representable, classes of hedonic games. In various such classes, agents' preferences may be encoded by means of a weighted and possibly directed graph from which cardinal utilities are extracted, depicting each agent's valuation of any other agent. The most natural choice of evaluating a coalition is via the \textit{summation} of its members' valuations of others within the coalition. This constitutes the thoroughly researched class of \textit{additively separable hedonic games} (ASHGs) \cite{bogomolnaia2002stability}. %, where an agent is willing to accept another agent into her coalition so long as her valuation of this agent is non-negative. ASHGs are thus not sensitive to the intensities of single agent preferences, and if all valuations are non-negative, forming the grand coalition consisting of all agents is optimal.
%

% As in our company event example, there are many contexts where it is more realistic to assume that agents arrive over time. Our model can be thus framed as a hedonic game with symmetric, binary and additively separable preferences where agents arrive one at a time in an \textit{online} fashion. Then, a central authority (i.e., an \textit{online} algorithm) has to \textit{immediately} and \textit{irrevocably} decide whether to add the agent into an existing coalition or to create a new one containing, at this moment, only her. Further, we assume that the input contains an upper bound $\alpha$ on the size of each coalition.
%

Unlike prior work which assumes that an arriving agent reveals her exact friendships with previously disclosed agents \cite{flammini2021online}, we consider scenarios where friendships are \textit{uncertain}, and design an online algorithm augmented with a \textit{coalitional friends predictor}, i.e., an oracle that predicts an agent's number of friends within a given coalition. Not only that such a predictor is simple and easy to interpret, it is also useful: Vertices' degree information has been previously employed in heuristic and approximation algorithms for other graph problems (e.g., maximum independent set \cite{halldorsson1994greed}). Since an agent's degree is simply her frequency in the union of all edges, a predictor can also be readily attained via estimation methods of elements' frequencies in a dataset, as used for certain data analysis problems \cite{hsu2019learning}.
%

% Unlike prior work on online coalition formation \cite{flammini2021online}, we consider scenarios where friendships are \textit{uncertain}, and design an online algorithm augmented with a coalitional friends predictor, i.e., an oracle that predicts an agent number of friends within a given coalition. Not only that such a predictor is simple and easy to interpret, it is also useful: Vertices' degree information has been previously employed in heuristic and approximation algorithms for other graph problems (e.g., maximum independent set \cite{halldorsson1994greed}). Since an agent's degree is simply her frequency in the union of all edges, a predictor can also be readily attained via estimation methods of elements' frequencies in a dataset, as used for certain data analysis problems \cite{hsu2019learning}.

% Specifically, we study a novel generalization of ASHGs that is inspired by Thiele methods \cite{thiele1895om}, termed as \textit{ASHGs}, where a real-valued function $f$ is applied to each agent's utility. This class allows us to model diminishing returns for each agent \cite{botan2021manipulability}: the second neighbor assigned to her coalition does not increase her utility as much as the first one. That is, under certain restrictions on $f$, grouping one agent with a second neighbor will not be favored over grouping another agent with her first. Further, we assume that the input contains upper bounds $\alpha,k$ on the size of each coalition and the number of coalitions (resp.).

%

The quality of a partition has been measured by various solution concepts, e.g., stability and optimality \cite{brandt2016introduction}. In this paper, we first explore the objective of \textit{maximizing the (utilitarian) social welfare}. We study a simple algorithm called \textit{Maximum Predicted Coalitional Friends} (MPCF), which assigns agents to coalitions greedily with respect to the predictor. For general graphs, MPCF returns a partition with a high social welfare even when the predictions are slightly off. For illustrating MPCF’s good performance, we follow a vast trend of research on average-case analysis (see, e.g., \cite{karp1981maximum,meka2009matrix}), and analyze MPCF also under a very natural and common random graph model: the Chung-Lu-Vu (CLV) model \cite{chung2004spectra}. %, which can generate power-law distributed graphs and generalizes the standard Erd\H{o}s-R\'{e}nyi model \cite{erdos59random}.
When the expected degree of each agent in the subgraph induced by any coalition is used as a prediction, we prove that MPCF stochastically dominates \textit{any} other algorithm for graphs drawn from the CLV model and analyze its expected social welfare. For \textit{deterministic} graphs, we show that it has the \textit{same} competitive ratio as the best known algorithm by Flammini et al. \shortcite{flammini2021online}. %Yet, when our problem is reformulated as a fractional hedonic game (FHG) \cite{aziz2019fractional}, we show that, under certain conditions, there is an algorithm whose asymptotic competitive ratio for Erd\H{o}s-R\'{e}nyi random graphs is at least $3.324$, improving upon the optimal bound of $4$ for scenarios without uncertainty \cite{flammini2021online}.

%Particualrly, for any degree distribution, any online algorithm $\mathcal{A}$ and any integer $k$, we show that the probability that $\mathcal{A}$ generates a partition of social welfare at least $k$ is upper bounded by the analogous probability under MPCF. %a prior probability over valuations which %are $1$-competitive, i.e., they compute an \textit{optimal} solution, but in time exponential in the number of agents $n$. %On the opposite extreme where no predictions are available, we supply tight or nearly tight bounds on the competitive ratio when regarding different types of valuations and conditions on $\alpha,k$.
%

Then, we explore \textit{proportionality}, which states that agents’ friendships should be reflected proportionately in the resulting partition. That is, as existing proportionality axioms in elections cannot be directly applied, we initiate the study of lifting them to ASHGs encoded by \textit{unweighted} and \textit{undirected} graphs. We devise \textit{coalitional} variants of \textit{Proportional Justified Representation} \cite{sanchez2017proportional} and \textit{Extended Justified Representation}  \cite{aziz2017justified} called \textit{CPJR} and \textit{CEJR} (resp.). Uncertainty about friendships allows us to supply a strong positive result: \textit{Under the CLV model, MPCF is optimal in terms of both social welfare as well as guaranteeing CPJR and CEJR}. %CPJR demands that within each coalition there are sufficiently many member that are each neighbors of at least one agent in the coalition, while CEJR requires that there exists at least one agent in each coalition neighboring a certain number of the coalition's members. Further, a partition is in the core if no coalition of agents blocks it.
When friendships are \textit{certain} this may not be the case, but we show that CPJR can be easily satisfied in polynomial-time, while CEJR is unsatisfied in online settings, yet it can be approximated. After showing that the best possible approximation is computationally hard to attain, we devise a polynomial-time scheme satisfying a slightly worse CEJR guarantee. %Finally, we prove that the same scheme satisfying CPJR also yields a logarithmic approximation for CS.

%

\section{Related Work}
Our work can be viewed as \textit{additively separable hedonic games} (ASHGs) \cite{bogomolnaia2002stability} with symmetric and binary preferences under the restriction that the size of each coalition is bounded. In such classes, agents' preferences are encoded by means of a weighted and possibly directed graph from which cardinal utilities are extracted, depicting each agent's valuation of any other agent. A coalition is then evaluated via the \textit{summation} of its members' valuations of others within the coalition. Hedonic games have been introduced by Dreze and Greenberg \shortcite{dreze1980hedonic}, and later expanded to the study of various solutions concepts such as stability, fairness, and optimality (see, e.g., \cite{aziz_savani_moulin_2016,woeginger2013core}). One major concern is designing computationally manageable classes of hedonic games, which led to an abundance of game representations. Some are \textit{ordinal} and can \textit{fully} express every preference over coalitions \cite{bouveret2010fair,elkind2009hedonic}, yet they may require exponential space. In contrast, \textit{cardinal} hedonic games, based on weighted graphs \cite{aziz2019fractional,bogomolnaia2002stability}, are \textit{not} fully expressive but only require \textit{polynomial} space for reasonable weights. Apart from ASHGs, averaging the weights within each coalition yields the classes of fractional hedonic games \cite{aziz2019fractional} and modified fractional hedonic games \cite{olsen2012defining}. ASHGs also contain friend-oriented hedonic games \cite{dimitrov2006simple} that distinguish between friends and enemies by allowing for only two possible weights. %Our generalization of ASHGs to ASHGs is subsumed by ASHGs and its subclasses, while encoding more universal utilities.
%

Partitions in hedonic games are typically measured in terms of stability and optimality. While in \cite{banerjee2001core,bogomolnaia2002stability} properties guaranteeing the existence of stable partitions in ASHGs were supplied, their computational aspects were studied in \cite{aziz2011stable,ballester2004np}. Yet, in our work we focus on maximizing social welfare, as studied in \cite{aziz2015welfare,monaco2020stable}. \cite{bullinger2020pareto,elkind2020price} also explore welfare-optimal partitions, as well as Pareto-optimality. In \textit{online} settings, Flammini et al. \shortcite{flammini2021online} study scenarios similar to standard \textit{symmetric} ASHGs, where agents arrive along with their incident edges. In contrast, we aim at maximizing social welfare in \textit{online} hedonic games when agents' friendships (and thus their utilities) are \textit{uncertain} (i.e., edges are \textit{not} revealed). Unlike Flammini et al. \shortcite{flammini2021online}, we focus not only on maximizing welfare, but also introduce \textit{proportionality} into hedonic games, which is a well-known topic in elections \cite{lackner2023approval}. %Cohen and Agmon \cite{cohen2023complexity} also modeled agents' uncertainty about friendships, yet in \textit{offline} settings.
%

Our work is also closely related to a recently popular trend of augmenting online algorithms with predictions, with the aim of bypassing the worst-case lower bounds of online problems caused by the uncertainty of the future. Though the idea of using advice to obtain semi-online algorithms is not new \cite{boyar2017online}, Munoz and Vassilvitskii \shortcite{munoz2017revenue} propose to use a predictor oracle for improving revenue optimization in auctions by setting a good reserve (or minimum) price, and Lykouris and Vassilvitskii \shortcite{lykouris2021competitive} consider the online caching problem with predictions. These works led to a series of learning augmented results in various fields (e.g., clustering \cite{dong2019learning}, ski-rental \cite{anand2020customizing}). To the best of our knowledge, we are the first to introduce predictions to online coalition formation problems, including a scheme that is stochastically optimal for realistic and natural random graphs.
%

Similarly to a recent work on online bipartite matching by Aamand et al. \shortcite{aamand2022optimal}, we also use predictions derived from agents' expected degrees. However, in their work agents arrive along with their incident edges, while in ours edges may not be revealed. Further, while they use an oracle that predicts an agent's degree \textit{in the full graph}, the oracle used by our MPCF algorithm predicts an agent's degree \textit{within the subgraph induced by a given coalition}. Their algorithm greedily matches an arriving agent with a \textit{minimum} predicted degree neighbor that is yet to be covered. In contrast, MPCF assigns an arriving agent to a coalition with \textit{maximum} predicted number of friends that has the \textit{minimum} total expected degree among such coalitions. In other graph problems, other kinds of predictions have also been used (See, e.g., \cite{antoniadis2020secretary,kumar2019semi}).
%

We also investigate \textit{proportional representation} in hedonic games, which is a central desiderata in elections \cite{lackner2023approval}. Most proportionality axioms in elections usually require that each sufficiently large group of agents is represented in the committee. For instance, extended justified representation \cite{aziz2017justified} enforces that there exists at least one voter approving a certain number of committee members, whereas proportional justified representation \cite{sanchez2017proportional} demands that there are sufficiently many committee members that are each approved by at least one voter. Stronger notions were later proposed, e.g., \cite{brill2022individual}. Though proportionality axioms have been also studied in online committee elections \cite{dey2017proportional,do2022online}, as far as we know, prior research did not regard such axioms as a fairness criteria in ASHGs (See, e.g., \cite{li2022partitioning}), let alone in online settings.

\section{Online Partitioning of Friends}
\label{sec:Online Partitioning of Friends}
We consider the problem of partitioning a finite set $N = \{1, \dots, n\}$ of $n$ agents within an undirected social network $G = (N, E)$ into coalitions, where an agent benefits from the arrival of another agent into her coalition so long as they are neighbors (i.e., friends). %Particularly, if all valuations are non-negative, the grand coalition consisting of all agents is optimal every agent.
Agent $i$'s preferences can thus be succinctly represented by a \textit{(binary) cardinal utility function} $v_i: N \rightarrow \{0,1\}$ with $v_i(i) = 0$ that satisfies $v_i(j) = 1$ if agent $j \neq i$ is a friend of agent $i$ (i.e., $(i,j) \in E$); otherwise, $v_i(j) = 0$. We denote by $\mathcal{N}_i$ the set of coalitions agent $i$ belongs to, i.e., $\mathcal{N}_i = \{C \subseteq N : i \in C\}$. Agent $i$'s utility can be \textit{additively} aggregated to preferences over each coalition $C \in \mathcal{N}_i$ via $v_i(C) = \sum_{j \in C} v_i(j)$. Such representation allows us to compare agents’ utilities such that a certain cardinal value expresses the same intensity of a preference for all agents. In fact, our model corresponds to \textit{additively separable hedonic games} (ASHGs) with symmetric and binary preferences \cite{bullinger2020pareto}, and thus our model will be referred to as an ASHG for briefness. %Further, as $\mathcal{N}_i$ is finite for each agent $i$, preferences could in principle always be depicted by cardinal values, and such representation is referred to as a \textit{cardinal hedonic game} (CHGs) \cite{bullinger2020pareto}. Though the resulting utilities require exponential space to represent, our model is an expressive but succinctly representable class of hedonic games since it encodes preferences as a undirected graph.
%

%Formally, ASHG can be naturally represented as a weighted directed graph $G = (N, E, v)$ whose weights are defined by the agents' utilities and are associated with non-zero utilities, i.e., if $v_i(j) \neq 0$ for a pair of agents $i,j$, then $E$ contains an arc $(i,j)$ of weight $v_i(j)$. If $v_i(j) = v_j(i)$ holds for all pairs of agents $i,j$, then the game is \textit{symmetric}. A game is \textit{simple} if $v_i(j) \in \{0,1\}$ for all agents $i,j$. In this work, we focus on ASHGs with simple and symmetric preferences, which can be expressed by an \textit{unweighted} and \textit{undirected} graph.


An outcome is thus a \textit{partition} $\mathcal{C}$ of $N$ into disjoint coalitions, where $|\mathcal{C}|$ denotes the number of its coalitions. Let $\mathcal{C}(i)$ be the coalition $C \in \mathcal{C}$ such that $i \in C$. Hence, for a partition $\mathcal{C}$, $\mathcal{C}(i) \succeq_i \mathcal{C}'(i)$ iff $v_i(\mathcal{C}) \geq v_i(\mathcal{C}')$, where $v_i(\mathcal{C}) = v_i(\mathcal{C}(i))$ is the utility $i$ receives from a partition $\mathcal{C}$. We focus on real-life scenarios where the size of each coalition is bounded. For instance, regarding our company event example, each table can accommodate a limited number of employees. Hence, for a positive integer $\alpha$, we consider partitions $\mathcal{C}$ that are \textit{$\alpha$-bounded}, i.e., $|C| \leq \alpha$ for every coalition $C \in \mathcal{C}$. We assume that $\alpha \geq 2$ as the case $\alpha=1$ is trivial. We denote by $\mathscr{C}_{\alpha}$ the collection of all $\alpha$-bounded outcomes. For an integer $n > 0$, for brevity, we henceforth denote $[n] := \{1,\dots,n\}$ where $[0] = \{0\}$.
%

%
% Inspired by Thiele methods \cite{thiele1895om}, given a function $f: \mathbb{R} \rightarrow \mathbb{R}$ with $f(0)=0$, we propose ASHG $\mathcal{G}^f = \langle N, (\succeq_i^f)_{i \in N} \rangle$, where agent $i$'s \textit{utility} for a coalition $C \in \mathcal{N}_i$ is $v_i(C) = f(v_i(C))$.
 %For certain choices of $f$ (e.g., \cite{botan2021manipulability}), the second neighbor grouped with an agent does not increase her utility as the first.
%

% Throughout the paper, we focus on (\textit{utilitarian}) \textit{welfare-optimality}. For a coalition $C \subseteq \mathcal{N}$, we let $\mathcal{SW}(C) = \sum_{i \in C} v_i(C)$ be the \textit{social welfare of $C$}. The \textit{social welfare of a partition $\mathcal{C}$} is then $\mathcal{SW}(\mathcal{C}) = \sum_{C \in \mathcal{C}} \mathcal{SW}(C) = \sum_{i \in \mathcal{N}} v_i(\mathcal{C})$. Hence, a partition $\mathcal{C}$ is \textit{welfare-optimal} if it maximizes the social welfare amongst all possible partitions, i.e., $\mathcal{C} \in \argmax_{\mathcal{C}' \in \mathscr{C}} \mathcal{SW}(\mathcal{C}')$. % Further, a coalition $C \subseteq \mathcal{N}$ is \textit{individually rational} (IR) if $v_i(C) \geq v_i(\{i\})$.
%

In our \textit{{online}} model, agents appear one at a time in the order $1, \dots, n$. At each time $t$, an online algorithm $\mathcal{A}$ shall produce a partial partition $\mathcal{C}^t$ of the agents \textit{who arrived until time $t$}, without any knowledge regarding future agents. Upon the arrival of agent $t$, $\mathcal{A}$ should \textit{immediately} and \textit{irrevocably} decide whether to insert her to an existing coalition in $\mathcal{C}^{t-1}$ or create a new coalition $\{t\}$. As the number of agents is not known upfront, from the perspective of an online algorithm, it may be possibly infinite. Prior research considered scenarios where friendships are revealed upon arrival \cite{flammini2021online}. See Appendix A for a sample instance in such settings.  %If either $k < n$, $\alpha < n$ or both, then $\mathcal{A}$ can further decide to reject an agent.
%
% As we regard \textit{simple} and \textit{symmetric} games, let $F_i$ be the friends of agent $i \in [t]$ (i.e., agent $i$'s neighborhood) in the graph underlying the ASHG at time $t$. Her utility for a coalition $C \subseteq [t]$ is thus $v_i(C) = |F_i \cap C|$.
Unlike prior studies, and unless stated otherwise, we consider that agents do \textit{not} reveal upon arrival their edges to previously arrived agents. For such environments, we consider online algorithms augmented with a "coalitional friends predictor" $\varphi_i: 2^{N} \rightarrow \mathbb{R}_{\geq 0}$ for each agent $i \geq 2$, which are possibly stochastic, inferred from additional knowledge about the graph or machine-learned from past data. We use such notation to stress that the predictors can operate on any coalition, but in practice they only operate on subsets of previously disclosed agents. Intuitively, the predictor captures agent $i$'s \textit{uncertainty} on her friendships: it is an oracle that, given any coalition $C \subseteq N$, predicts the number of agent $i$'s friends within $C$. We also assume that we are given $\varphi_i(N)$, which predicts agent $i$'s degree in the full graph. For the predictor to be well-defined, we assume that $\varphi_i(C) = \sum_{j \in C} \varphi_i(\{j\})$ $\forall C \subseteq N$. %We also assume that we are given a \textit{degree predictor} $\psi: N \rightarrow \mathbb{R}_{\geq 0}$, which is an oracle that, given any agent $i$, predicts her degree in the full graph.


% \section{Optimality in Online Hedonic Games}
% \label{sec:Optimality in Online Hedonic Games}
\section{Maximizing Social Welfare under Uncertainty}
\label{sec:Maximizing Welfare using Predictions}

\begin{algorithm}[tb]
    \caption{\textbf{Maximum Predicted Coalitional Friends}}
    \label{alg:MPCF}
    % \textbf{Input:} $\varphi_i$ $\forall i \geq 2$
    \begin{algorithmic}[1] %[1] enables line numbers
        \STATE Initialize an empty partition $\mathcal{C} \leftarrow \emptyset$.
        \WHILE{an online agent $t \in N$ arrives}
            \STATE Set $\mathcal{C}' = \{C \in \mathcal{C}: |C| < \alpha\}$.
            \IF {$|\mathcal{C}'| > 0$}
                \STATE Set $\mathcal{S} = \argmax_{C \in \mathcal{C}'} \varphi_t(C)$.
                \STATE $C = \argmin_{C \in \mathcal{S}} \sum_{i \in C} \varphi_i(N)$ (ties broken randomly)
                \STATE{Add agent $t$ to the coalition $C$.}
            \ELSE
                \STATE Create a new coalition $\{t\}$ and add it to $\mathcal{C}$.
            \ENDIF
        \ENDWHILE
    \end{algorithmic}
    \textbf{Output:} The partition $\mathcal{C}$.
\end{algorithm}

In this section, we evaluate the quality of partitions by measures of optimality. For a coalition $C \subseteq \mathcal{N}$, let $\mathcal{SW}(C) = \sum_{i \in C} v_i(C)$ be the \textit{social welfare of $C$}. The \textit{social welfare of a partition $\mathcal{C}$} is then $\mathcal{SW}(\mathcal{C}) = \sum_{C \in \mathcal{C}} \mathcal{SW}(C) = \sum_{i \in \mathcal{N}} v_i(\mathcal{C})$. Hence, a partition $\mathcal{C}$ is \textit{welfare-optimal} if it maximizes the social welfare amongst all possible partitions, i.e., $\mathcal{C} \in \argmax_{\mathcal{C}' \in \mathscr{C}_\alpha} \mathcal{SW}(\mathcal{C}')$. For an integer $\alpha \geq 2$, the central goal of an online algorithm $\mathcal{A}$ is computing a welfare-optimal $\alpha$-bounded partition $\mathcal{C}^n$.
%

% While Flammini et al. \cite{flammini2021online} provide bounds on the competitive ratio in scenarios where friendships are \textit{certain}, we next consider settings where an arriving agent's friendships are \textit{uncertain}. For such environments, we design an online algorithm augmented with a "coalitional friends predictor" $\varphi_i: 2^{[i]} \rightarrow \mathbb{R}_{\geq 0}$ for each agent $i \geq 2$, which is possibly inferred from additional knowledge about the graph or machine-learned from past data. Intuitively, the predictor is an oracle that, given any coalition $C \subseteq N$, predicts the number of agent $i$'s friends within $C$. For the predictor to be well-defined, we assume that $\varphi_i(C) = \sum_{j \in C} \varphi_i(\{j\})$ for any coalition $C \subseteq N$.
%

Our \textit{Maximum Predicted Coalitional Friends} (\textbf{MPCF}) algorithm (Algorithm \ref{alg:MPCF}) uses the predictors to greedily assign an arriving agent $t$ to a coalition $C \in \mathcal{C}^t$ of size less than $\alpha$ that contains the maximum predicted number of friends, which yields the maximum increase in the social welfare of the current partition. If multiple such coalitions exist, the algorithm assigns agent $t$ to the coalition $C$ whose total predicted expected degree within the entire graph is \textit{minimal}, i.e., $C$ minimizes $\sum_{i \in C} \varphi_i(N)$. Intuitively, coalitions with \textit{low} total degrees should be filled as early as possible since we will have more chances to assign agents to coalitions with \textit{higher} total degrees. If no such coalition exists, then MPCF creates a new coalition $\{t\}$.

As an algorithm, MPCF is simple, but our main novelty is the analysis of its behaviour with respect to the quality and choice of the predictors. For general graphs, we show that MPCF maintains a high social welfare even when the predictors are \textit{noisy}. For depicting its good performance, we prove that MPCF is \textit{optimal} for a very natural random graph model and analyze its expected social welfare. In the sequel, we denote the coalition to which agent $i$ is assigned by an online algorithm $\mathcal{A}$ as $\mathcal{A}_i(G)$. %and recall that agent $i$'s utility $v_i(\mathcal{A}_i(G))$ is the number of agent $i$'s friends within her assigned coalition.
For brevity, we hereafter denote MPCF by $\mathcal{A}^\star$.


\subsection{Robustness of MPCF to Noisy Predictors}
\label{sec:MPCF with Noisy Predictors}
Generally, we would like the algorithm to perform well when the predictions are decent (or even accurate), yet maintain reasonable performance even when the predictions are slightly \textit{noisy}. For \textit{general} graphs, we thus show that MPCF will return a partition with a high social welfare even when the predictions are slightly off. Formally, given another predictor $\varphi' = (\varphi_i')_{i \in N}$, $\varphi_i$ and $\varphi_i'$ may disagree upon their predictions of agent $i$'s friendship with any other agent $j$ (i.e., $\varphi_i(\{j\}) \neq \varphi_i'(\{j\})$ may hold) and thus induce different orderings on the agents who arrived \textit{before} agent $i$. Thus, let $\Delta(\varphi_i,\varphi_i')$ be the \textit{minimal} set of agents that should be removed such that the two predictors $\varphi_i$ and $\varphi_i'$ will induce the same ordering over the remaining agents in $[i-1]$.

Let $\Delta(\varphi,\varphi') := \cup_{i \in N} \Delta(\varphi_i,\varphi_i')$. We give an upper bound on the difference between the social welfares incurred by executing MPCF with the predictors $\varphi_i$ and $\varphi_i'$ (Theorem \ref{thm:noisy}). Given any other predictor $\varphi'$, we infer that MPCF will still be near-optimal for a small enough value of $|\Delta(\varphi,\varphi')|$. In particular, $|\Delta(\varphi,\varphi')|$ is upper bounded by the number of mispredicted neighbors of each agent.
% \begin{lemma}
%     \label{lemma:at most 1 removed}
%     Let $G = (N,E)$ be a graph and consider an agent $j \in N$. For each agent $i$, consider a coalitional friends predictor $\varphi_i$. Then, MPCF with predictors $\varphi_i$ when executed on $G' = (N \setminus \{j\}, E)$ will yield a partition whose social welfare is at least the one incurred when executed on $G$.
% \end{lemma}

\begin{theorem}
    \label{thm:noisy}
    Let $\mathcal{A}^\star_{\varphi}(G)$ be the partition generated by MPCF with a predictor $\varphi$ on a graph $G$. Then, $\mathcal{SW}(\mathcal{A}^\star_{\varphi'}(G)) \geq \mathcal{SW}(\mathcal{A}^\star_{\varphi}(G)) - |\Delta(\varphi,\varphi')|(2\alpha-3)$ for any pair of predictors $\varphi$ and $\varphi'$.
\end{theorem}
\begin{proof}
    (\textit{Sketch})
    In Appendix B, we first prove by induction that the removal of a single agent in the graph $G$ cannot yield a better social welfare. Then, we invoke this result inductively on the graph $G'$ resulting from the removal of the agents in $\Delta(\varphi,\varphi')$ to obtain $\mathcal{SW}(\mathcal{A}^\star_{\varphi'}(G)) \geq \mathcal{SW}(\mathcal{A}^\star_{\varphi'}(G'))$. An agent $j \in \Delta(\varphi,\varphi')$ can receive at most a utility of at most $\alpha-1$. Upon the removal of agent $j$, the utility of agent $j$'s neighbors reduces by at most $1$, and thus the partition's social welfare can decrease by at most $2\alpha - 3$. By invoking this reasoning recursively: $\mathcal{SW}(\mathcal{A}^\star_{\varphi}(G)) \leq \mathcal{SW}(\mathcal{A}^\star_{\varphi}(G')) + |\Delta(\varphi,\varphi')|(2\alpha-3)$. Our result follows from $\mathcal{SW}(\mathcal{A}^\star_{\varphi}(G')) = \mathcal{SW}(\mathcal{A}^\star_{\varphi'}(G'))$ as removing the agents in $\Delta(\varphi,\varphi')$ yields that the predictors $\varphi$ and $\varphi'$ induce the same set of predicted friends for each agent.
\end{proof}

Namely, so long as $\varphi$'s number of mispredicted neighbors for each agent $i$ is \textit{small}, MPCF is still \textit{near-optimal}.

% Consider the predictor $\varphi = (\varphi_i)_{i \in N}$ for which, $\varphi_i$ returns the expected number of agent $i$'s friends within a given coalition for each agent $i$.

%

\subsection{Optimality of MPCF for the CLV Model}
\label{sec:Optimality of MPCF for the CLV Model}
For depicting MPCF’s good performance and effectively analyzing it, we consider the natural Chung-Lu-Vu (CLV) random graph model \cite{chung2004spectra} that generates graphs with arbitrary expected degree sequences. Our analysis stresses the applicability of our algorithm to practical graphs since the CLV model can generate graphs with power law distributed degrees, exhibited by many real-world graphs, e.g., Internet topology \cite{chung2004spectra}. By Newman, Watts, and Strogatz \shortcite{newman2002random}, one can obtain a fairly accurate model of many social networks by using the Molloy-Reed method \cite{molloy1995critical}, which samples a graph from a family of random graphs with degrees distributed following a power law with exponential cutoff.

% generalizes the standard Erd\H{o}s-R\'{e}nyi model \cite{erdos59random} in which each each edge is independently chosen with the probability $p \in (0,1]$. In Erd\H{o}s-R\'{e}nyi random graphs the expected degrees of agents all have the same expected value, while the CLV model extends them to a general degree distribution.
%

% Under the above choice for the predictors, we next show that the social welfare of the partition returned by MPCF stochastically dominates the social welfare incurred by \textit{any} other algorithm $\mathcal{A}$, i.e., MPCF is optimal for graphs within the CLV model (Section \ref{sec:Optimality of MPCF for the CLV Model}). Even if the predictors are noisy, we show that MPCF still incurs a high social welfare. Then, we analyze MPCF in terms of its expected social welfare (Section \ref{sec:behaviour of MPCF}). As those results do not explicitly provide MPCF's competitive ratio, we show in Remark \ref{remark:competitive analysis} that MPCF's competitive ratio for deterministic graphs ($p_i \in \{0,1\} \forall i$) is the \textit{same} as the best known online algorithm for our problem. %By formulating our problem as a fractional HG instead of an ASHG, we also achieve an asymptotic competitive ratio of at least $3.324$ under the Erd\H{o}s-R\'{e}nyi model (Section \ref{sec:beating 4}). This result provides a better guarantee than the optimal $4$-approximation algorithm in the settings without uncertainty proposed by Flammini et al. \cite{flammini2021online}.

% In the sequel, we first provide several technical lemmas, which will then aid us in proving our main result.
Formally, for a sequence $\mathbf{p} = (p_1, \dots, p_n) \in [0,1]^n$, we consider the random graph $G_\mathbf{p}$ in which each pair of agents $i\neq j$ are friends with probability $p_i p_j$ and these events are mutually independent. This model corresponds to the setting where agents pick their edges with probabilities proportional to $\mathbf{p}$ which describes the relative distribution over the agents. Within this model, for each agent $i$ we use the coalitional friends predictor that returns the expected number of agent $i$'s friends within a coalition $C \subseteq [i]$, i.e., $\varphi_{i}(C) = p_i \sum_{j \in C} p_j$. Under this choice of predictors, we next show that the social welfare of the partition returned by MPCF \textit{stochastically dominates} the social welfare incurred by \textit{any} other algorithm $\mathcal{A}$, i.e., MPCF is \textit{optimal} for graphs within the CLV model. First, we treat the case that an algorithm $\mathcal{A}$ may leave an agent $i$ in a singleton coalition even when her neighborhood is non-empty. Specifically, we prove in Lemma \ref{lemma:non empty} that an agent having no friends hinders the social welfare of the partition generated by MPCF compared to the case where his neighborhood is non-empty.
\begin{lemma}
    \label{lemma:non empty}
    Under the CLV model, let $\mathbf{p} \in [0,1]^n$ be a weight vector. For any agent $i$, let $\mathbf{p}_{-i} \in [0,1]^{n-1}$ be obtained from $\mathbf{p}$ by removing its $i^{th}$ entry. Then, $\mathbb{P}[\mathcal{SW}(\mathcal{A}^\star(G_{\mathbf{p}})) \geq k] \leq \mathbb{P}[\mathcal{SW}(\mathcal{A}^\star(G_{\mathbf{p_{-i}}})) \geq k -v_i(\mathcal{A}^\star_i(G_{\mathbf{p}}))]$ and $\mathbb{P}[v_j(\mathcal{A}^\star_j(G_{\mathbf{p}})) \geq k] \leq \mathbb{P}[v_j(\mathcal{A}^\star_j(G_{\mathbf{p_{-i}}})) \geq k - 1]$ for each agent $j\neq i$ and any $k \geq 0$. %In particular, for each agent $j\neq i$,  for any $k \geq 0$.
\end{lemma}
\begin{proof}
    (\textit{Sketch})
    The proof in Appendix C shows that for any instance graphs $G$ and $G_{-i}$ of $G_{\mathbf{p}}$ and $G_\mathbf{p_{-i}}$ (resp.), $\mathcal{SW}(\mathcal{A}^\star(G_{-i})) \geq \mathcal{SW}(\mathcal{A}^\star(G)) - v_i(\mathcal{A}^\star_i(G))$ holds.
\end{proof}

Next, we show that another appealing property of MPCF is its capability of leveraging the density of a graph for attaining a higher social welfare. Given two weight vectors $\mathbf{p}, \mathbf{p}' \in [0,1]^n$, we say that $\mathbf{p}'$ \textit{dominates} $\mathbf{p}$ if $p_i \leq p_i'$ for every agent $i$. This indicates that a graph distributed as ${G}_{\mathbf{p}'}$ is \textit{denser} than a graph distributed as ${G}_{\mathbf{p}}$. In Appendix D, we prove that the social welfare of the partition generated by MPCF for a given graph is stochastically dominated by the social welfare obtained for a \textit{denser} one:
\begin{lemma}
    \label{lemma:dominates}
    Under the CLV model, let $\mathbf{p}, \mathbf{p}' \in [0,1]^n$ be s.t. $\mathbf{p}'$ dominates $\mathbf{p}$. Then, $\mathbb{P}[\mathcal{SW}(\mathcal{A}^\star(G_{\mathbf{p}})) \geq k] \leq \mathbb{P}[\mathcal{SW}(\mathcal{A}^\star(G_{\mathbf{p}'})) \geq k]$ $\forall k \geq 0$.
\end{lemma}

We now give our main result about MPCF's optimality:

\begin{theorem}
    \label{thm:MPCF is optimal}
    Under the CLV model, let $\mathbf{p} \in [0,1]^n$ be a weight vector and let $\mathcal{A}$ be an online algorithm for our problem. Then, $\mathbb{P}[\mathcal{SW}(\mathcal{A}(G_{\mathbf{p}})) \geq k] \leq \mathbb{P}[\mathcal{SW}(\mathcal{A}^\star(G_{\mathbf{p}})) \geq k]$ for any $k \geq 0$. In particular, for each agent $i$, $\mathbb{P}[v_i(\mathcal{A}_i(G_{\mathbf{p}})) \geq k] \leq \mathbb{P}[v_i(\mathcal{A}^\star_i(G_{\mathbf{p}})) \geq k]$ for any $k \geq 0$.
\end{theorem}
\begin{proof}
    (\textit{Sketch})
    The proof in Appendix E stems from Lemmas \ref{lemma:non empty} by induction on the number of agents $n$.
\end{proof}

Theorem \ref{thm:MPCF is optimal} proves that MPCF is \textit{\textbf{optimal}} for the CLV model. It also indicates that even if some online algorithm $\mathcal{A}$ satisfies Lemma \ref{lemma:dominates}, MPCF still exploits the graph's density better than $\mathcal{A}$ by Theorem \ref{thm:MPCF is optimal}. Though optimality only holds when the predictions are each agent's expected number of friends within a given coalition, MPCF is still near-optimal if the predictions are noisy due to Theorem \ref{thm:noisy}.

%Formally, given another predictor $\varphi' = (\varphi_i')_{i \in N}$, $\varphi_i$ and $\varphi_i'$ may disagree upon their predictions of agent $i$'s friendship with any other agent $j$ (i.e., $\varphi_i(\{j\}) \neq \varphi_i'(\{j\})$ may hold) and thus induce different orderings on the agents who arrived \textit{before} agent $i$. Let $\Delta(\varphi_i,\varphi_i')$ be the \textit{minimal} set of agents that should be removed such that $\varphi_i$ and $\varphi_i'$ will yield the same ordering on the remaining agents. In Appendix \ref{supp:Noisy Predictions}, we prove that the social welfare incurred by MPCF with $\varphi'$ will reduce by at most $O(|\cup_{i\in N} \Delta(\varphi_i,\varphi_i')|)$. Intuitively, so long as $\varphi$'s number of mispredicted neighbors for each agent $i$ is small, MPCF is still near-optimal.

\subsubsection{The Expected Social Welfare of MPCF.}
\label{sec:behaviour of MPCF}

We herein analyze the expected social welfare incurred by MPCF under the CLV model for $n \geq 3$, in both the asymptotic and the non-asymptotic case. %In this section, we thus first analyze the behaviour of MPCF under the CLV model for $n \geq 3$. %, in which we consider the random graph $G_{\mathbf{d}}$ that is parameterized by the number of agents $n$ and a vector $\mathbf{d} = \{d_i\}_{i\in [n]}$, where $d_i$ is the expected degree of agent $i$ and agents $i\neq j$ are friends with probability $d_i d_j / n$. As in Section \ref{sec:Optimality of MPCF for the CLV Model}, we analyze MPCF when the predictions for each agent $i$ are given by the expected number of agent $i$'s friends within a coalition $C \subseteq [i-1]$, i.e., $\varphi_i(C) = d_i \sum_{j \in C} d_j/n$.
%
Our first main result within this model is a set of equations that describe the social welfare incurred by MPCF. First, we consider the set $I$ of the agents in $G_{\mathbf{p}}$ that are assigned to singleton coalitions by MPCF. Let $G^+_{\mathbf{p}} = (N, E_{\mathbf{p}}^+)$ be the graph obtained from $G_{\mathbf{p}}$ as follows: If $p_i p_j > 0$ for a pair of agents $i\neq j$, then $(i,j) \in E_{\mathbf{p}}^+$. Let $c_\ell$ be the number of coalitions in $\mathcal{A}^\star(G_\mathbf{p})$ with exactly $\ell$ agents. We prove the following relation between the partition returned by MPCF and the graph $G^+_{\mathbf{p}}$:
\begin{lemma}
    \label{lemma:isolated}
    Under the CLV model, let $\mathbf{p} \in [0,1]^n$ and let $I$ be the agents in the graph $G_{\mathbf{p}}$ that are assigned to singleton coalitions by MPCF. Then, $I$ is an independent set of $G^+_{\mathbf{p}}$. Further, each coalition $C \in \mathcal{A}^\star(G_\mathbf{p})$ is connected in $G^+_{\mathbf{p}}$ and $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p})) \leq \sum_{\ell=1}^\alpha \ell(\ell-1) c_\ell$. Since $n - |I| = \sum_{\ell=2}^\alpha \ell c_\ell$, then $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p})) \leq (\alpha-1) (n-|I|)$.
\end{lemma}
\begin{proof}
    Assume, towards contradiction, that the partition generated by $G_{\mathbf{p}}$ contains two isolated agents $i<j$ with $p_i p_j > 0$. Then, when $j$ appears, MPCF adds agent $j$ to the coalition $\{i\}$, which contradicts the fact that $j$ is isolated. Thus, $I$ is an independent set of $G^+_{\mathbf{p}}$. Next, note that when an agent $i$ is inserted to an existing coalition $C$, there exists at least one agent $j \in C$ such that $p_i p_j > 0$ by Algorithm \ref{alg:MPCF}. Hence, $C$'s social welfare is at most $|C|(|C|-1)$, yielding that $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p})) \leq \sum_{\ell=1}^\alpha \ell(\ell-1) c_\ell$.
\end{proof}



We next show how to compute $|I|$ for a \textit{symmetric} variant of the CLV model for $n \geq 3$, where we consider the random graph $G_{\mathbf{d}}$ parameterized by the number of agents $n$ and a vector $\mathbf{d} = \{d_i\}_{i\in [n]}$, while $d_i$ is the expected degree of agent $i$. Any pair of agents $i\neq j$ with the same expected degree $d$ are friends with probability $d / n$. As in the previous section, we can analyze MPCF when the predictions for each agent $i$ are given by the expected number of agent $i$'s friends within a coalition $C \subseteq N$, i.e., $\varphi_i(C) = |\{j \in C: d_j = d_i\}| \cdot d_i /n$. %in a \textit{symmetric} variant of the CLV model for $n \geq 3$, in which we consider the random graph $G_{\mathbf{d}}$ that is parameterized by the number of agents $n$ and a vector $\mathbf{d} = \{d_i\}_{i\in [n]}$, where $d_i$ is the expected degree of agent $i$. Any pair of agents $i\neq j$ with the same expected degree $d$ are friends with probability $d / n$. As in Section \ref{sec:Optimality of MPCF for the CLV Model}, we analyze MPCF when the predictions for each agent $i$ are given by the expected number of agent $i$'s friends within a coalition $C \subseteq N$, i.e., $\varphi_i(C) = \sum_{j \in C: d_j = d_i} d_j/n$.
%
% Note that agent $i$'s \textit{expected} degree within the entire graph is given by $d_i = p_i \sum_{j \neq i} p_j$. %We denote by $d_{\max}$ the maximum expected degree.
% The case where $p_{i} = 0$ for any agent $i$ except for at most two agents is simple, and we thus hereafter assume that at least three weights are positive.
Let $Y_t^d$ be the number of agents with expected degree $d$ who are in singleton coalitions by MPCF after agent $t$ arrives. %In Appendix F, we prove that $p_i = p_{i'}$ and $m_d := \sum_{j \neq i} p_j = \sum_{j \neq i'} p_j$ for any two agents $i,i'$ with expected degree $d$ and $\sum_{j \neq i,i'} p_j > 0$.
$\{Y_t^d\}_{t\in [n]}$ is a Markov chain whose expected evolution is:
\begin{equation}
    \label{eq:markov}
    \mathbb{E}[Y_{t+1}^d-Y_t^d] = -\Big(1-\Big(1- \frac{d}{n}\Big)^{Y_t^d}\Big) \Pi_{d' \leq d} \Big(1- \frac{{d'}}{n}\Big)^{Y_t^{d'}}
\end{equation}
% \begin{equation}
%     \label{eq:markov}
%     \mathbb{E}[Y_{t+1}^d-Y_t^d] = -(1-(1- q_{t+1}^d)^{Y_t^d}) \Pi_{d' \leq d} (1- q_{t+1}^{d'})^{Y_t^{d'}}
% \end{equation}
The first term is the probability that at least one isolated agent with expected degree $d$ is a friend of agent $t+1$, and the second term is the probability that agent $t+1$ has no isolated friend with lower expected degree (which would have been prioritized). Letting $k_t^d = -\log(1- d / n)$ and $Z_t^d = -k_t^d \cdot Y_{t}^d$, \eqref{eq:markov} can be simplified as:
\begin{equation}
    \label{eq:markov2}
    \mathbb{E}[Z_{t+1}^d-Z_t^d] = k_t^d (1- e^{Z_t^d}) \Pi_{d' < d} e^{Z_t^{d'}}
\end{equation}
Following Kurtz \cite{kurtz1971limit} and many subsequent works (See, e.g., \cite{aamand2022optimal}), these Markov chains can be approximated by the solution of the following system of differential equations:
\begin{equation}
    \label{eq:diff}
    \frac{\mathrm{d} z^d(t)}{\mathrm{d} t} =  k_t^d (1- e^{z^d(t)}) \Pi_{d' < d} e^{z^d(t)}
\end{equation}
% If we were to assume that $k_t^d$ is independent of the time step $t$ (i.e., $\frac{\mathrm{d} k_t^d}{\mathrm{d} t} = 0$), then the solution $z^d(t)$ to \eqref{eq:diff} can be derived in a manner similar to \cite[Appendix G]{aamand2022optimal}. An example satisfying that assumption is a \textit{symmetric} variant of the CLV model for $n \geq 3$, in which we consider the random graph $G_{\mathbf{d}}$ that is parameterized by the number of agents $n$ and a vector $\mathbf{d} = \{d_i\}_{i\in [n]}$, where $d_i$ is the expected degree of agent $i$. Any pair of agents $i\neq j$ with the same expected degree $d$ are friends with probability $d / n$. As in the previous section, we can analyze MPCF when the predictions for each agent $i$ are given by the expected number of agent $i$'s friends within a coalition $C \subseteq N$, i.e., $\varphi_i(C) = |\{j \in C: d_j = d_i\}| \cdot d_i /n$. Under this model, note that if agent $t+1$ has an expected degree of $d_{t+1}$, then $p_{t+1} d_{t+1} / m_{d_{t+1}}$ in \eqref{eq:markov} is substituted by $d_{t+1} / n$, which yields that $k_t^{d_{t+1}}$ is independent of $t$ as $k_t^{d_{t+1}} = -\log(1- d_{t+1} / n)$. On the other hand, for each $d \neq d_{t+1}$, note that $\mathbb{E}[Y_{t+1}^d-Y_t^d] = 0$ since agent $t+1$ cannot be a friend of an agent with a different expected degree.
%

As $k_t^d$ is independent of time $t$, there is a constant $k^d$ s.t. $k_t^d \equiv k^d$. Similarly to \cite[Theorem 6.1]{aamand2022optimal}, we obtain that the solution $z^d(t)$ approximates the number of isolated agents with expected degree $d$ at time $t$ via $-z^d(t)/k^d$. In fact, by letting $\{\delta_f\}_{f=1}^\ell$ be the unique expected degrees, we obtain that $|I|$ can be approximated by $\sum_{f=1}^\ell -z^{\delta_f}(t)/k^d$. We now conclude that the solution to \eqref{eq:diff} thus provides an \textit{approximate} upper bound in terms of $\{\delta_f\}_{f=1}^\ell$ on $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p}))$ for the non-asymptotic case, which is exact in the asymptotic case where $n \rightarrow \infty$: %Since $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p})) \leq  (\alpha-1) (n-|I|)$ (Lemma \ref{lemma:isolated}), we conclude an expected upper bound on the social welfare of the partition generated by MPCF when executed on $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p}))$:
% \begin{equation}
%     \label{eq:expected upper bound}
%     (\alpha-1) (n+\sum_{f=1}^\ell z^{\delta_f}(n)/k^{\delta_f})
% \end{equation}
\begin{lemma}
    \label{lemma:expected upper bound}
    As $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p})) \leq  (\alpha-1) (n-|I|)$ (Lemma \ref{lemma:isolated}), we infer an expected upper bound of $(\alpha-1) (n+\sum_{f=1}^\ell z^{\delta_f}(n)/k^{\delta_f})$ on the social welfare of the partition generated by MPCF when executed on $\mathcal{SW}(\mathcal{A}^\star(G_\mathbf{p}))$.
\end{lemma}

In Appendix G, we provide a similar system for the general CLV model, whose solution can be similarly derived for cases such as the symmetric CLV model, and discuss its solvability. Now, we analyze MPCF's expected social welfare for Erd\H{o}s-R\'{e}nyi random graphs, where all edges in a random graph $G_p$ independently appear with the same probability $p \in [0,1]$. Each agent's expected degree is the same and equals to $d := np$. For a wide range of the parameters $n$, $\alpha$, $p$, we give in Appendix H an \textit{exact} expression for MPCF's expected social welfare (up to a small additive error):
\begin{theorem}
    \label{thm:expected sw for erdos}
    Let ${p} \in [0,1]$ and $n, \alpha \in \mathbb{N}$. Assume that $p = o(\log n)/n$ and $p \geq 1/ n^{1+o(1)}$. Then, %$\mathbb{E}[M_i] =  n + \alpha  -\frac{\ln (e^{p\alpha} + e^{pn} - 1 )) }{p} \pm n^{1/2 + o(1)}$.
    % \begin{equation}
    %     \label{lemma:eq:upper lower bound t fin}
    %     \begin{aligned}
    %         \mathbb{E}[M_i] =  n + \alpha  -\frac{\ln (e^{p\alpha} + e^{pn} - 1 )) }{p} \pm n^{1/2 + o(1)}
    %     \end{aligned}
    % \end{equation}
    % In particular, $|M_i - \mathbb{E}[M_i]| = O(\sqrt{n \log n})$ with high probability dependent on $n$. Further,
    $\mathbb{E}[\mathcal{SW}(\mathcal{A}^\star(G_{{p}}))] = n^2 + \alpha n - \frac{n \ln (e^{p\alpha} + e^{pn} - 1 ) }{p} \pm n^{1.5 + o(1)}$.
\end{theorem}

% \subsection{Competitive Analysis of MPCF}
% \label{sec:Competitive Analysis of MPCF}

% \subsection{Worst-Case Competitive Ratio of MPCF}
% \label{sec:Worst-Case Competitive Ratio}


\begin{remark}
    \label{remark:competitive analysis}
    {\normalfont (Deterministic Graphs)}
    %Despite MPCF's optimality in the CLV model, our previous results do not supply MPCF's competitive ratios.
    % By Flammini et al. \cite[Theorem 3.8]{flammini2021online}, for undirected and unweighted graphs, no deterministic online algorithm has a competitive ratio better than $\alpha-1$. In fact, they provide a greedy algorithm that is almost optimal and achieves a strict competitive ratio of $\alpha$. One may wonder whether an algorithm with access to the agents' expected degrees can obtain a better worst-case competitive ratio. We answer this question negatively for a restricted CLV model where weights are binary (i.e., $p_i \in \{0,1\}$ for any agent $i$), in which the resulting graph is deterministic and is exactly $G^+_{\mathbf{p}}$. In that case, MPCF is equivalent to the greedy algorithm devised by Flammini et al. \cite{flammini2021online}, and from \cite[Theorem 3.9]{flammini2021online} we infer that the strict competitive ratio of MPCF the weights are binary is $\alpha$.
    By Flammini et al. \shortcite[Theorem 3.8]{flammini2021online}, for undirected and unweighted graphs, no deterministic online algorithm has a competitive ratio better than $\alpha-1$. For a restricted CLV model where weights are binary (i.e., $p_i \in \{0,1\}$ for any agent $i$), the resulting graph is deterministic and is exactly $G^+_{\mathbf{p}}$. In that case, MPCF is equivalent to the strictly $\alpha$-competitive greedy algorithm devised by Flammini et al. \shortcite[Theorem 3.9]{flammini2021online}, and we infer MPCF on deterministic graphs is almost optimal and achieves a strict competitive ratio of $\alpha$.
\end{remark}

% \begin{corollary}
%     \label{thm:competitive ratio}
%     Let $\mathbf{p} \in [0,1]^n$ be a weight vector such that $p_i \in \{0,1\}$ for any agent $i$. Then, the strict competitive ratio of MPCF under the CLV model with binary weights is $\alpha$.
% \end{corollary}

% \subsection{Beating $4$ for Simple and Symmetric FHGs}
% \label{sec:beating 4}
% As MPCF does not improve the greedy algorithm of Flammini et al. \cite{flammini2021online} under the CLV model with binary weights, a natural question is whether there exist other formulations of our problem for which we can achieve a better performance by leveraging predictions. We answer this question \textit{positively} by considering several modifications of our setup. Thus far, at each time $t$, we have considered that the utility of each agent $i$ for a coalition $C \subseteq[t]$ is the number of her friends within $C$. Alternately, we can define agent $i$'s utility as the \textit{fraction} of her friends within $C$, i.e., $v_i^F(C) = |F_i \cap C| / |C|$, which results in a \textit{fractional hedonic game} (FHG) \cite{aziz2019fractional} with symmetric and binary preferences. Recall that in prior sections we assumed that an arriving agent's friendships are not revealed. In contrast, in this section we consider that each agent $i$ arrives along with her incident edges, while agent $i$ is uncertain about her neighbors' number of friends.
% %

% Note that, for the problem's formulation as an FHG, the grand coalition is not necessarily optimal even when the size of each coalition is \textit{unbounded} (i.e., $\alpha = n$). Thus, we hereafter consider that $\alpha = n$ and our goal is designing an online algorithm that beats the optimal $4$-approximation algorithm for online settings \textit{without} predictions which returns a maximal matching \cite{aziz2015welfare,flammini2021online}. A maximal matching of an undirected and unweighted graph is a partition where each coalition is connected and consists of at most two agents, while any pair of non-matched agents is not connected by an edge. Inspired by Aamand et al. \cite{aamand2022optimal}, we devise the \textit{Maximal Matching by Minimum Predicted Degree} (M3PD) algorithm that is given a degree predictor $\psi: N \rightarrow \mathbb{R}_{\geq 0}$. Unlike prior sections, $\psi$ is an oracle that, given any agent $i$, predicts her degree in the full graph. Under the CLV model, we use the degree predictor that returns the expected degree of each agent, i.e., $\varphi_i(N)=d_i$. M3PD executes similarly to the online bipartite matching algorithm in \cite{aamand2022optimal}: when agent $t$ arrives, she is added to an existing coalition of size $1$ that is adjacent to $t$ and has the minimum predicted degree among all of agent $t$'s friends. If no such coalition exists, a new coalition $\{t\}$ is created.
% %

% Next, we explain how the results for the algorithm proposed by Aamand et al. \cite{aamand2022optimal} can be readily applied to M3PD. Since our considered graphs are not necessarily bipartite, we can make them bipartite using the \textit{bipartite double cover method} \cite{borodin2019experimental}. Given a graph $G=(N,E)$, its bipartite double cover is the graph $G' = (A' \cup B' , E')$ where $U' = \{a_1', \dots, a_n'\}$ and $B'= \{b_1', \dots, b_n'\}$ are copies of $N$ and there is an edge $\{a_i',b_j'\} \in E'$ if and only if $\{i,j\} \in N$. Thus, a maximal matching of $G$ induces a maximal matching of $G'$, and vice versa. If we were to view $A'$ and $B'$ as the online and offline agents (respectively), then executing the algorithm in \cite{aamand2022optimal} on $G'$ yields the same matching as the one returned by M3PD on $G$. Hence, M3PD is optimal under the CLV model by \cite{aamand2022optimal}. Further, by Flammini et al. \cite{flammini2021online} a maximal matching is $4$-competitive for our problem, and the matching returned by M3PD has an asymptotic competitive ratio of at least $0.831$ for the maximal matching problem under the Erd\H{o}s-R\'{e}nyi model due to Aamand et al. \cite{aamand2022optimal}. We therefore infer that:
% \begin{lemma}
%     \label{lemma:results from mpd}
%     M3PD's asymptotic competitive ratio for Erd\H{o}s-R\'{e}nyi random graphs as $n \rightarrow \infty$ is at least $4 \cdot 0.831 = 3.324$.
% \end{lemma}
% \begin{proof}
%     Let $\mathcal{C}^\star$ be a welfare-optimal partition, $M^\star$ be the partition induced by a maximum matching and $\mathcal{C}$ be the partition returned by M3PD. Let $A^\star$ and $A$ be the set of non-isolated agents in $M^\star$ and $\mathcal{C}$ (respectively), whose social welfares are then $|A|^\star / 2$ and $|A| / 2$ (respectively), i.e., the sizes of the matchings corresponding to those partitions. By Aziz et al. \cite{aziz2015welfare}, $\mathcal{SW}(\mathcal{C}^\star) / [|A|^\star / 2] \geq 4$, while $|A|^\star / |A|$ is asymptotically at least $0.831$ due to Aamand et al. \cite{aamand2022optimal}, from which we infer the desired as $\frac{\mathcal{SW}(\mathcal{C}^\star)}{|A| / 2} = \frac{\mathcal{SW}(\mathcal{C}^\star)}{|A|^\star / 2} \cdot \frac{|A|^\star / 2}{|A| / 2}  $.
% \end{proof}
% %



% % Although MPCF is optimal within the CLV model, our results in Section \ref{sec:Optimality of MPCF for the CLV Model} do not supply MPCF's competitive ratios (in neither the asymptotic nor the non-asymptotic case). In this section we thus analyze the behaviour of MPCF under the Erd\H{o}s-R\'{e}nyi model, in which we consider the random graph $G_{d}$ that is parameterized by the number of agents $n$ and $d$ is the expected degree of each agent $i$ such that agents $i \neq j$ are friends with probability $d/n$. As in Section \ref{sec:Optimality of MPCF for the CLV Model}, we analyze MPCF when the predictions for each agent $i$ are given by the expected number of agent $i$'s friends within a coalition $C \subseteq N$, i.e., $\varphi_i(C) = |C| \cdot d/n$.
% %

% % Our first main result within this model is a set of equations that describe the social welfare of the partition generated by MPCF in the non-asymptotic and the asymptotic cases. Initially, we denote by $G_d^+ = (N, E_d^+)$

% % We let $Y_t$ be the number of agents who are still assigned to singleton coalitions by MPCF after agent $t$ arrives. As such, $\{Y_t\}_{t\in [n]}$ form a Markov chain with the following expected evolution:
% % \begin{equation}
% %     \label{eq:markov}
% %     \mathbb{E}[Y_{t+1}-Y_t] = -\Big(1-\Big(1- \frac{d}{n}\Big)^{Y_t}\Big)
% % \end{equation}
% % where the term in \eqref{eq:markov} is the probability that at least one isolated agent is a friends of agent $t+1$. Letting $k = -\log(1- d / n)$ and $Z_t = -k \cdot Y_{t}$, we can simplify \eqref{eq:markov} as follows:
% % \begin{equation}
% %     \label{eq:markov2}
% %     \mathbb{E}[Z_{t+1}-Z_t] = k (1- e^{Z_t})
% % \end{equation}
% % Following Kurtz \cite{kurtz1971limit} and many subsequent works (See, e.g., \cite{aamand2022optimal}), we show in Appendix \ref{sec:eq 3} that these Markov chains can be approximated by the solution of the following differential equation:
% % \begin{equation}
% %     \label{eq:diff}
% %     \frac{\mathrm{d} z(t)}{\mathrm{d} t} = k (1 - e^{z(t)})
% % \end{equation}
% % whose solution is $z(t) = - \log((e^{kn} - 1) e^{-kt} + 1)$ with the initial condition $z(0) = - kn$. Therefore, the solution $z(t)$ approximates the number of isolated agents at time $t$ via $-z(t)/k$.

% %In the sequel, we stu whidy the competitive ratio of any online algorithm $\mathca friends of agent $t+1$al{A}$ for maximizing social welfare. Formally, given an instance $I$ of OASHGs, let $OPT(I)$ and $\mathcal{A}(I)$ be an arbitrary optimal partition and a partition returned by $\mathcal{A}$ on input $I$ (resp.). $\mathcal{A}$ is \textit{$r$-competitive} if there exists some $b \geq 0$ s.t. $\mathcal{SW}(\mathcal{A}(I)) \geq \mathcal{SW}(OPT(I))/r - b$ for any instance $I$. If $b=0$, then $\mathcal{A}(I)$ is \textit{strictly} $r$-competitive. The (strict) competitive ratio of $\mathcal{A}$ is the smallest $r$ s.t. $\mathcal{A}$ is (strictly) $r$-competitive. %First, we supply \textit{worse} competitive ratios for general OASHGs (Subsection \ref{sec:Maximizing Welfare without Predictions}). For \textit{simple} and \textit{symmetric} games with a constant number of agents $n$, we then obtain a $1$-competitive algorithm enhanced with \textit{perfect} predictions (Subsection \ref{sec:Maximizing Welfare using Perfect Predictions}). Using prefect predictions comes with a computational expense, but yields an optimal partition.

% % \subsection{Maximizing Welfare \textit{Without} Predictions}
% % \label{sec:Maximizing Welfare without Predictions}
% % In this section, we study the competitive ratio for general OASHGs when \textit{no} predictions are available. Unlike \cite{flammini2021online}, in OASHGs the graph underlying the game may be either directed or undirected and a more general social welfare is considered, posing more challenges. Next, we distinguish the analysis between the cases where the size of a coalition is either unbounded or bounded.% In the proofs of the lower bounds, we assume such an algorithm exists and construct an online input supplied by an adversary that forces a contradiction.

% % \subsubsection{\textit{Unbounded} Coalition size ($\alpha \geq n$)}
% % When the size of a coalition is unbounded, the grand coalition is optimal in the case of non-negative valuations. Hence, we herein regard games containing both positive and negative valuations. When the number of coalitions $k$ is also \textit{bounded}, \cite{flammini2021online} supply impossibility results that can be readily applied to \textit{symmetric} OASHGs with $f(x)=x$, which thus apply to general OASHGs. Hence, we hereafter assume that the number of coalitions is \textit{unbounded}. Letting $U = \max_{i,j} |v_i(j)|$ be the maximum absolute valuation, then  we prove the following lower bound in Appendix \ref{supp:Unbounded Number of Coalitions}:
% % \begin{theorem}
% %     \label{thm:both are unbounded}
% %     When both $\alpha,k$ are unbounded, there exists no deterministic online algorithm for maximizing welfare with a (strict) competitive ratio of $f(U)(n-2)/(2f(1))-\varepsilon$ $\forall \varepsilon > 0$.
% % \end{theorem}
% % \begin{proof}
% %     (\textit{Sketch}) By contradiction, we assume such an algorithm $\mathcal{A}$ exists. An adversary releases two incident agents. Noting that $\mathcal{A}$ must group them together, the adversary issues additional agents whose valuations force a contradiction.
% % \end{proof}

% % Similarly to \cite{flammini2021online}, we now consider the \textsc{Greedy} algorithm, which assigns each arriving agent $t$ to the coalition that brings the maximum \textit{positive} increase in the social welfare of the current partition. If no such coalition exists, then \textsc{Greedy} creates a new coalition $\{t\}$. In Appendix \ref{supp:Unbounded Number of Coalitions greedy}, we prove that the following holds:
% % \begin{theorem}
% %     \label{thm:greedy}
% %     When both $\alpha, k$ are unbounded and $f$ is monotonically increasing (i.e., $f(x) \leq f(y)$ for every $x \leq y$), \textsc{Greedy} is strictly $f(U(n-1))/f(1)$-competitive.
% % \end{theorem}
% % \begin{proof}
% %     (\textit{Sketch}) We first prove that the social welfare increases by at least $f(1)$ after an agent joins an existing coalition, and thus the welfare of the resulting partition is at least $f(1)n$. Noting that $v_i(C) \leq f(U(n-1))$ for any agent $i$ and coalition $C$, the optimal partition's welfare is at most $n f(U(n-1))$, yielding the desired competitive ratio.
% % \end{proof}

% % \subsubsection{\textit{Bounded} Coalition size ($2 \leq \alpha < n$)}
% % If both the coalition size and the number of coalitions are bounded, then the size of the instance is bounded, in which case every algorithm is $1$-competitive by \cite{flammini2021online}. Thus, we hereafter assume that the number of coalitions is \textit{unbounded} ($k \geq n$). In Appendix \ref{supp:Unbounded Number of Coalitions-- General Valuations}, we prove: %the following lower bound on the competitive ratio:
% % \begin{theorem}
% %     \label{thm:bounded alpha}
% %     For general valuations, there exists no deterministic online algorithm for maximizing welfare with a competitive ratio of $r=2(\alpha - 1)f(U)-\varepsilon$ $\forall \varepsilon > 0$.
% % \end{theorem}
% % \begin{proof}
% %     (\textit{Sketch}) Similar to Theorem \ref{thm:both are unbounded}, an adversary releases agents in $T$ phases s.t. the welfare of the optimal partition is at least $T(r+\varepsilon)$ and that of the partition after phase $m-1$ is $m f(1)$. A certain choice of $T$ yields a contradiction.
% % \end{proof}

% % Similarly to \cite{flammini2021online}, we now consider the \textsc{Greedy}$_\alpha$, a variant of \textsc{Greedy} that does not consider coalitions of size $\geq \alpha$ as possible. In Appendix \ref{supp:greedy-- General Valuations}, we prove:
% % \begin{theorem}
% %     \label{thm:greedy alpha}
% %     For general valuations, if $f$ is monotonically increasing, then \textsc{Greedy}$_\alpha$ is strictly $\max ( \beta , \beta - \beta/n )$-competitive, where $\beta := f(U(\alpha-1))/f(1)$.
% % \end{theorem}
% % \begin{remark}
% %     \label{remark:greedy alpha}
% %     The results concerning \textsc{Greedy}$_\alpha$ stem from its properties as proven in Lemma 1 of Appendix \ref{supp:greedy-- General Valuations}.
% % \end{remark}

% % The grand coalition is not necessarily a feasible solution as $\alpha$ is bounded. Further, the proofs for Theorems \ref{thm:bounded alpha}-\ref{thm:greedy alpha} are invalid for positive weights as the adversary uses \textit{negative} valuations. Thus, in Appendices \ref{supp:Unbounded Number of Coalitions-- positive Valuations}-\ref{supp:greedy-- positive Valuations} we prove that:
% % \begin{theorem}
% %     \label{thm:bounded alpha positive}
% %     For positive valuations, there exists no deterministic online algorithm for maximizing welfare with a competitive ratio of $(\alpha - 1)f(U)^{1-\varepsilon}$ $\forall \varepsilon > 0$.
% % \end{theorem}
% % % \begin{proof}
% % %     (\textit{Sketch}) By contradiction, we assume such an algorithm $\mathcal{A}$ exists with an additive term $b \geq 0$. An adversary chooses $\alpha > n$ and releases a sufficiently large independent set until $\mathcal{A}$ either forms a coalition of $\alpha$ agents or $\alpha-1$ coalitions.
% % % \end{proof}
% % \begin{theorem}
% %     \label{thm:greedy alpha positive}
% %     For positive valuations, if $f$ is monotonically increasing, then \textsc{Greedy}$_\alpha$ is strictly $\alpha f((\alpha-1)U)/[f(1)(\alpha - 1)]$-competitive (Recall Remark \ref{remark:greedy alpha}).
% % \end{theorem}


% % \subsection{Maximizing Welfare using Predictions}
% % \label{sec:Maximizing Welfare using Perfect Predictions}
% % When preferences are \textit{simple} and \textit{symmetric}, for which case \cite{flammini2021online} provide bounds on the competitive ratio, we next design \textit{$1$-competitive} online algorithms augmented with a prior probability over valuations (possibly machine-learned) that compute an \textit{optimal} solution. Using predictions comes with a computational expense compared to the \textit{more efficient} algorithms devised in Subsection \ref{sec:Maximizing Welfare without Predictions}, but yields an optimal partition. If the size of a coalition is unbounded ($\alpha \geq n$), then the grand coalition is an optimal partition since the weights are non-negative. Hence, we consider it to be bounded, i.e., $2 \leq \alpha < n$. If the number of coalitions is also bounded ($k < n$), then the size of the instance becomes bounded, in which case every algorithm is $1$-competitive by \cite{flammini2021online}. In this section we thus assume that $k$ is \textit{unbounded} (i.e., $k \geq n$), and we will hereafter term $\alpha$-bounded partitions as $\alpha$-bounded for brevity.
% % %

% % Specifically, at time $t$, we assume the \textit{accurate} probability that each agent $i \in [t-1]$ has a non-zero valuation for the arriving agent $t$ is known to the online algorithm, denoted as $\mathcal{P}^t_i = Pr[v_i(t) \neq 0]$. Such probabilities may depend on each agent $i$, while the events $v_i(t) \neq 0$ and $v_j(t) \neq 0$ for $i \neq j$ may also be dependent. In practice, such predictions can be derived, e.g., by computing the frequencies of agents approving the arriving agent based on past online instances.
% % %

% % At time $t$, we denote by $\mathcal{P}^t(C, m)$ the probability that $m$ agents in a coalition $C$ have a non-zero valuation for the arriving agent $t$. As we will subsequently observe, for our results to hold we solely require that $\mathcal{P}^t(m)$ is polynomial-time computable. Hence, for briefness we hereafter assume that $\mathcal{P}^t_i$ have the same value $\mathcal{P}^t$ for each agent $i$, that the events $v_i(t) \neq 0$ and $v_i(t) = 0$ are independent, and the events $v_i(t) \neq 0$ and $v_j(t) \neq 0$ for $i \neq j$ are also independent, which translates to independence across coalitions. Thus, for deriving our algorithms, we require the probability $\mathcal{P}^t(\mathcal{C}^t, \{m_C\}_{C \in \mathcal{C}^t})$ that $m_C$ agents in a coalition $C \in \mathcal{C}^t$ have a non-zero valuation for the arriving agent $t$, given by $\mathcal{P}^t(\mathcal{C}^t, \{m_C\}_{C \in \mathcal{C}}) = \Pi_{C \in \mathcal{C}} \mathcal{P}^t(C, m_C)$, where $\mathcal{P}^t(C, m) = \binom{|C|}{m} (\mathcal{P}^t)^m (1 - \mathcal{P}^t)^{|C|-m}$. %That is, letting $\mathcal{P}^t(\mathcal{C}^t, \{m_C\}_{C \in \mathcal{C}^t})$ be the probability that $m_C$ agents in a coalition $C \in \mathcal{C}^t$ have a non-zero valuation for the arriving agent $t$, we have: $\mathcal{P}^t(\mathcal{C}^t, \{m_C\}_{C \in \mathcal{C}}) = \Pi_{C \in \mathcal{C}} \mathcal{P}^t(C, m_C)$.
% % %

% % Our objective is thus devising an \textit{assignment policy} $\pi$ which decides for every arriving agent $t$ whether to insert it to an existing coalition in $\mathcal{C}^{t-1}$ or create a new coalition $\{t\}$ based on previous time steps. %Past experience induces a \textit{$t$-step history} $h^t = \{(t, a^t, N^t)\}_{\tau \in [t]}$ comprised of each arriving agent $t$ along with the index $a^t \in [k]$ of her chosen coalition and the previously arrived agents $N^t \subseteq [t-1]$ that comprise her neighbors in the unweighted and undirected graph induced by the game at time $t$. $h^t$ is terminal if $t = n$.
% % A \textit{feasible} policy $\pi$ can only make \textit{feasible} assignments, i.e., the assignment at each time $t$ yields a $\alpha$-bounded partition $\mathcal{C}^t$ by satisfying $|\mathcal{C}^{t}| \leq k$ and $|C| \leq \alpha$ for every $C \in \mathcal{C}^{t}$. As policy $\pi$ induces a probability distribution over the generated partitions, we aim at designing an assignment policy $\pi^\star$ that generates a partition that is welfare-optimal (in expectation), i.e., $\pi^\star \in \argmax_{\pi} \mathbb{E}_{\{\mathcal{C}^{t}\}_{t \in [n]} \sim \pi} [\mathcal{SW}(\pi(\mathcal{C}^{n}))]$. We remark that the derived optimal feasible policy largely depends on the choice of the function $f$. Therefore, we first supply a polynomial-time dynamic programming scheme for classical ASHGs (Lemma \ref{lemma:classic}), and then depict in Remark \ref{remark:coverage} its extension to maximizing coverage (i.e., the number of agents who approve at least one agent within their coalition). Finally, we generalize to OASHGs given any $f$.
% % %

% % % \subsubsection{Classical Online Additively Separable HGs}
% % Setting $f(x) = x$ $\forall x \in \mathbb{R}$ induces classical ASHGs. As we regard \textit{simple} and \textit{symmetric} games, let $F_i$ be the neighborhood of agent $i \in [t]$ in the graph underlying the ASHG at time $t$, and her utility for a coalition $C \subseteq [t]$ is thus $v_i(C) = |F_i \cap C|$. Further, we encode each time instant $t$ as a \textit{state} $s_t = (t, (\beta_\ell^t)_{\ell \in [n]}, (\gamma^t_\ell)_{\ell \in [n]})$, where $\beta_\ell^t \in [\min(\alpha, t-1)] \cup \{0\}$ is the number of agents assigned to the $\ell^{th}$ possible coalition so far, and $\gamma^t_\ell \in [\alpha] \cup \{0\}$ is the number of agents within the $\ell^{th}$ coalition that have a non-zero valuation for agent $t$. If the $\ell^{th}$ coalition is empty, then $\gamma^t_\ell = 0$. The number of states is $O(n \alpha^{2n})$ as there are $n$ and $\alpha^{2n}$ possible values for $t$ and $(\beta^t =(\beta_\ell^t)_{\ell}, \gamma^t = (\gamma^t_\ell)_{\ell})$ (resp.).
% % %

% % Among the $n$ possible coalitions, if state $s_t$ may contain coalitions with at least $2$ agents, then the resulting partition will eventually contain strictly less than $n$ coalitions. Letting $\mathcal{J}_t$ be the set of all agents $i \in [t]$ assigned to a coalition $\ell$ with $\ell \neq i$, we infer that $\mathcal{X}_t := [t] \setminus \mathcal{J}_t$ is the set of all plausible coalitions' indices at time $t$. Accordingly, a state is \textit{terminal} if either $t = n$ or $ \beta_\ell^t = \alpha$ agents have been assigned to each coalition $\ell \in \mathcal{X}_t$, where in the latter case a state is \textit{full}. %A state is \textit{tight} if summing the number of already assigned agents and the number of agents yet to arrive is $\alpha k$, i.e., $\sum_{\ell} \beta_\ell^t + n - t + 1 = \alpha k$.
% % In every full state, a feasible policy must not allow any action to be taken. Each state $s_t$ may also contain coalitions that are yet to be assigned with agents, and we thus denote their indices as $\mathcal{I}_t = \{\ell \in \mathcal{X}_t : \beta_\ell^t = 0\}$.
% % %

% % Let $\mathcal{Q}(s_t,  a_t)$ be the expected utility at state $s_t$ when taking action $a_t \in \mathcal{X}_t$. We now describe the conditions $\mathcal{Q}$ should satisfy for ensuring that the generated policy is feasible. Whenever the state $s_t$ satisfies $\beta_\ell^t = \alpha$ for some $\ell \in \mathcal{X}_t$ at time $t$, agents can no longer be assigned to the $\ell^{th}$ coalition, i.e., we set $\mathcal{Q}(s_t, \ell) = 0$ for any such $\ell$. Particularly, if $t < n$ and $\beta_\ell^t = \alpha$ for all $\ell \in \mathcal{X}_t$ except for a \textit{single} coalition $\tilde{\ell} \in [n]$ (i.e., $\beta_{\tilde{\ell}}^t < \alpha$), then the remaining agents can be only assigned to $\tilde{\ell}$, i.e., we set $\mathcal{Q}(s_t, \ell) = 0$ $\forall \ell \neq \tilde{\ell}$ and $\mathcal{Q}(s_t, \tilde{\ell}) = \gamma^{t}_{\tilde{\ell}}$. If $\beta_\ell^t = \alpha$ for each $\ell \in \mathcal{X}_t$ at time $t$, then no agents can be assigned to any coalition from time $t+1$ onward, i.e., we set $\mathcal{Q}(s_t, \ell) = 0$ $\forall \ell \in \mathcal{X}_t$. Finally, agents cannot be assigned to any \textit{implausible} coalition whose index is $\ell \in \mathcal{J}_t$, i.e., $\mathcal{Q}(s_t, \ell) = 0$ $\forall \ell \in \mathcal{J}_t$. Those conditions thus assure that the number of agents already assigned to the $\ell^{th}$ coalition satisfies $\alpha - n + t -1 \leq \beta_\ell^t \leq \alpha$ at any time instant, whereas for $t=n$ we note that its possible values are only $\alpha - 1$ or $\alpha$.
% % %

% % Next, let $C^{t,\ell}$ be the $\ell^{th}$ possible coalition at time $t$ and $\mathcal{V}^\star(s_t)$ is the expected utility of an optimal feasible policy at state $s_t$. Moreover, we let $s(t+1, a_t, \gamma^{t+1}) = (t+1, (\beta_\ell^{t+1})_{\ell \in [n]}, \gamma^{t+1} = (\gamma_\ell^{t+1})_{\ell \in [n]})$ be the state obtained from $s_t$ when the arriving agent is assigned to coalition $a_t$ (i.e., $\beta_{a_t}^{t+1} = \beta_{a_t}^{t} + 1$ whereas all other values remain as in $s_t$) and each coalition indexed by $\ell$ has $\gamma^{t+1}_\ell \in [\beta_\ell^{t+1}] \cup \{0\}$ agents with a non-zero valuation for agent $t+1$. $\mathcal{Q}$ satisfies a set of Bellman equations, described as follows. For each $a_t \in \mathcal{I}_t$, the arriving agent is assigned to a coalition which is currently empty, i.e., the index of such coalition is within $\mathcal{I}_t$. Regardless of the choice among these coalitions, we also need to distinguish between the possible number of agents within non-empty coalitions that approve $t+1$. $Q$ thus satisfies:
% % \begin{equation}
% %     \label{eq:empty coalitions}
% %     \begin{aligned}
% %         \mathcal{Q}(s_t, a_t) = \sum_{\gamma^{t+1} \in \times_{\ell \in [n]}([\beta_\ell^{t+1}] \cup \{0\})} \mathcal{P}^t(\mathcal{C}^{t+1}, \gamma^{t+1}) \cdot \\
% %         \mathcal{V}^\star(s(t+1, a_t, \gamma^{t+1})) \quad \forall a_t \in \mathcal{I}_t
% %     \end{aligned}
% % \end{equation}

% % Next, for each $a_t \in \mathcal{X}_t \setminus \mathcal{I}_t$, the arriving agent is assigned to a non-empty coalition. As the game is simple and symmetric, once agent $t$ is assigned to the $a_t$-th coalition, an additional utility of $\gamma^{t}_{a_t}$ is incurred. Thereby, $Q$ satisfies:
% % \begin{equation}
% %     \label{eq:existing coalitions}
% %     \begin{aligned}
% %         \mathcal{Q}(s_t, a_t) = \sum_{\gamma^{t+1} \in \times_{\ell \in [n]}([\beta_\ell^{t+1}] \cup \{0\})} \big[\mathcal{P}^t(\mathcal{C}^{t+1}, \gamma^{t+1}) \cdot \\
% %         \mathcal{V}^\star(s(t+1, a_t, \gamma^{t+1}))\big] + \gamma^{t}_{a_t} \quad \forall a_t \in \mathcal{X}_t \setminus \mathcal{I}_t
% %     \end{aligned}
% % \end{equation}

% % Finally, $\mathcal{V}^\star(s_t)$ is obtained via $\mathcal{V}^\star(s_t) = \max_{a_t \in [n]} \mathcal{Q}(s_t, a_t)$. Given a state $s_t$, the assignment policy $\pi$ is greedy with respect to $\mathcal{Q}(s_t, a_t)$, i.e., $\pi(s_t) \in \argmax_{a_t \in [n]} \mathcal{Q}(s_t, a_t)$ (ties are broken in favor of already assigned coalitions). Recalling that there are $O(n \alpha^{2n})$ states, and since each one requires a summation over $O(\alpha^n)$ terms, we can obtain the optimal feasible policy via dynamic programming by iterating over all state from $t=n$ downwards to $t=1$ (i.e., by backward induction). However, as formulated in the following lemma, the resulting algorithm runs in time exponential in the number of agents $n$, and is thus polynomial only for a \textit{constant} $n$.
% % \begin{lemma}
% %     \label{lemma:classic}
% %     An optimal feasible policy can be computed in $O(n \alpha^{3n})$ time for classical online ASHGs (i.e., $f(x)=x$).
% % \end{lemma}

% % \begin{remark}
% %     \label{remark:coverage}
% %     {\normalfont (Maximizing Coverage)} By selecting $f(x) = \min(x,1)$, the social welfare of the partition $\mathcal{C}^t$ is $\mathcal{SW}(\mathcal{C}^t) = \sum_{C \in \mathcal{C}^t}|\{i \in C : F_i \cap C \neq 0\}|$, which constitutes the number of agents who are neighbors of at least one agent within their coalition. In multiwinner approval voting \cite{elkind2022price}, this notion is typically termed as {\normalfont coverage}. The algorithm for maximizing coverage is similar to the one supplied by Lemma \ref{lemma:classic}, except for requiring a larger state space. Particularly, agent $t$ contributes a value of $1$ to the current partition's social welfare if some agent who have no neighbors within their coalition is $t$'s neighbor; otherwise, $t$ contributes $0$. Namely, we should reason about the number of agents who has no neighbors within their coalition thus far and the ones who are neighbors of the currently observed agent. In Appendix \ref{supp:Maximizing Coverage in Online Additively Separable Hedonic Games}, we thus formally show how the preceding algorithm can indeed be adapted for maximizing coverage.
% % \end{remark}

% % When considering general OASHGs, the states for the previous case are insufficient since for each agent $i$ we are further required to encode the number of her neighbors within her coalition so as to quantify $i$'s contribution to the partition's social welfare. This requires $O(n \alpha^{4n})$ states, and we thus conclude that (See Appendix \ref{supp:Maximizing general} for a detailed proof):
% % \begin{theorem}
% %     \label{thm:general oashgs}
% %     An optimal feasible policy can be computed in $O(n \alpha^{5n})$ time for OASHGs.
% % \end{theorem}


\section{Proportionality in Online Hedonic Games}
\label{sec:Proportionality Axioms in OASHGs}
The principle of \textit{proportional representation} in the context of HGs states that agents’ friendships should be reflected proportionately in the resulting partition. Informally, most agents shall be somewhat satisfied by that partition, which should also best represent the spectrum of different friendships within the society. Yet, existing proportionality axioms do not directly apply to HGs: capturing proportionality in HGs requires to reason about \textit{multiple} coalitions instead of a \textit{single} committee (see, e.g., \cite{aziz2017justified}). Within each coalition, any subgroup of agents with similar sets of friends should have a number of friends that is proportional to the size of the subgroup. For instance, in our company event example, consider $100$ employees and that each table can accommodate at most $10$ participants. If there is a table where $50\%$ of the participants have at least $5$ common friends, then those participants should have at least $5$ friends in their table. In this section, we thus lift proportionality axioms from the multi-winner voting realm to hedonic games.
%

% We herein focus on proportionality in scenarios \textit{without uncertainty} (i.e., friendships are revealed). Namely, at each time $t$ and for each agent $i \in [t]$, let $\mathcal{N}_i^t = \{C \subseteq [t] : i \in C\}$ be all possible coalitions containing agent $i$ and let $F_i$ be agent $i$'s friends in the social network. Thus, agent $t$ arrives along with $v_t^t$, where $v_i^t: \mathcal{N}_i^t \rightarrow \{0,1\}$ is the valuations of agent $i \in [t]$ to the agents \textit{who arrived until time $t$}. Her utility for a coalition $C \subseteq [t]$ is the number of her friends within $C$, i.e., $v_i(C) = |F_i \cap C|$. $\mathbf{v}^t = (v_i^t)_{i \in [t]}$ is the joint valuation of the agents \textit{who arrived until time $t$}.
%

For evaluating and formulating new variants of proportionality that are suitable for \textit{simple} and \textit{symmetric} ASHGs, we assume the number of agents $n$ is \textit{known}. First, we define the notion of \textit{coalitional cohesiveness}, which extends the notion of cohesiveness in elections \cite{aziz2017justified} to hedonic games. Cohesiveness dictates that the preferences within each subgroup of any coalition are sufficiently aligned. Recall that $F_i$ is agent $i$'s neighborhood in the social network at time $t$. Given an integer $\alpha \geq 2$, for any $C \in \mathcal{C}^t$ and each $m \in [\alpha]$, we say that a subgroup $S \subseteq C$ is \textit{$m$-coalitionally cohesive} (or \textit{$m$-cohesive} for short) if $|S| \geq m \cdot \frac{n}{\alpha}$ (i.e., $S$ is large enough) and $|\cap_{i \in S} F_i| \geq m$ (i.e., $S$'s members have at least $m$ common neighbors). We also adapt the \textit{approximate} variant of cohesiveness explored by \cite{do2022online}. Given $\eta \geq 1$, the above subgroup of agents $S \subseteq C$ is \textit{$(\eta, m)$-cohesive} if $|S| \geq \eta \cdot m \cdot \frac{n}{\alpha}$ and $|\cap_{i \in S} F_i| \geq m$.
%

Next, we redefine and study notions of proportionality in the context of hedonic games, that are commonly considered in the committee elections literature, which include proportional justified representation (PJR) \cite{sanchez2017proportional} and extended justified representation (EJR) \cite{aziz2017justified}, as well as their approximate versions. The extension of proportional justified representation (PJR) \cite{sanchez2017proportional} to hedonic games demands that the preferences of sufficiently large and cohesive groups of agents shall not be disregarded by the resulting partition, but shall be adequately represented in each coalition. Formally, coalitional PJR is defined as follows:
\begin{definition}
    \label{def:pjr}
    % {\normalfont (CPJR)}
    Given $\eta \geq 1$, the partition $\mathcal{C}^t$ at time $t$ satisfies {\normalfont $\eta$-coalitional PJR} ($\eta$-\textbf{CPJR}) if for each coalition $C \in \mathcal{C}^t$, for all $m \in [\alpha]$ and for each $(\eta, m)$-cohesive subgroup of agents $S \subseteq C$, it holds that the agents within $S$ are jointly friends of at least $m$ agents within $C$, i.e., $\sum_{i \in S} v_i(C) \geq m$.
\end{definition}

The stronger notion of coalitional EJR \cite{aziz2017justified} demands that there exists at least one agent in each large enough and cohesive coalition with not just one, but several friends within the coalition. Formally:
\begin{definition}
    \label{def:ejr}
    % {\normalfont (Coalitional EJR)}
    Given $\eta \geq 1$, the partition $\mathcal{C}^t$ at time $t$ satisfies {\normalfont $\eta$-coalitional EJR} ($\eta$-\textbf{CEJR}) if for each coalition $C \in \mathcal{C}^t$ it holds that for each $m \in [\alpha]$ and each $(\eta, m)$-cohesive subgroup of agents $S \subseteq C$ there exists an agent $i \in S$ that is friends with at least $m$ agents within $C$, i.e., $v_i(C) \geq m$.
\end{definition}

If a partition satisfies $1$-CPJR, then we say that it satisfies CPJR for brevity. CEJR is defined similarly. By \cite{brill2022individual}, CPJR is implied by CEJR in the committee elections setting, and thus CEJR provides a stronger axiomatic guarantee of proportionality. Next, we analyze CPJR and CEJR when friendships are revealed, where CPJR can be easily attained under mild assumptions, while CEJR can be approximated. When friendships are \textit{uncertain}, we show that our MPCF algorithm is \textit{optimal} under the CLV model, yet it does not always satisfy CPJR and CEJR under full certainty.


% The extension of proportional justified representation (PJR) \cite{sanchez2017proportional} to hedonic games demands that the preferences of sufficiently large and cohesive groups of agents shall not be disregarded by the resulting partition, but shall be adequately represented in each coalition. Formally, coalitional PJR is defined as follows:
% \begin{definition}
%     \label{def:pjr}
%     {\normalfont (Coalitional PJR)} Given $\eta \geq 1$, the partition $\mathcal{C}^t$ at time $t$ satisfies {\normalfont $\eta$-coalitional PJR} ($\eta$-CPJR) if for each coalition $C \in \mathcal{C}^t$, for all $m \in [\alpha]$ and for each $(\eta, m)$-cohesive subgroup of agents $S \subseteq C$, it holds that the agents within $S$ jointly approve at least $m$ agents within the coalition $C$, i.e., $\sum_{i \in S} v_i(C) \geq m$.
% \end{definition}

% If a partition satisfies $1$-CPJR, then we say that it satisfies CPJR for brevity.
\subsection{Proportionality when Friendships are Revealed}
\label{sec:Proportionality when Friendships are Revealed}
We first study CPJR and CEJR in scenarios \textit{without uncertainty} (i.e., friendships are revealed). In such settings, at each time $t$ and for each agent $i \in [t]$, let $\mathcal{N}_i^t = \{C \subseteq [t] : i \in C\}$ be all possible coalitions containing agent $i$ and let $F_i$ be agent $i$'s friends in the social network. Thus, agent $t$ arrives along with $v_t^t$, where $v_i^t: \mathcal{N}_i^t \rightarrow \{0,1\}$ is the valuations of agent $i \in [t]$ to the agents \textit{who arrived until time $t$}. Her utility for a coalition $C \subseteq [t]$ is the number of her friends within $C$, i.e., $v_i(C) = |F_i \cap C|$. $\mathbf{v}^t = (v_i^t)_{i \in [t]}$ is the joint valuation of the agents \textit{who arrived until time $t$}.

\subsubsection{Achieving CPJR.}
\label{sec:Proportional Justified Representation (PJR)}
CPJR can be easily satisfied by an adaption of the \textit{method of equal shares} (MES) \cite{peters2021proportional,peters2020proportionality}, which we term \textit{coalitional MES} (\textbf{CMES}) and it executes as follows. Each agent $i$ has an initial budget of \textit{one} dollar. Agent $i$ spends her money across the execution by buying any agent $j$ she approves of (i.e., $v_i(j) = 1$). Namely, at time $t$, agent $t$ is assigned to a coalition whose members that approve $t$ have at least $n/\alpha$ dollars in total, where those members are then asked to jointly pay $n/\alpha$ dollars. If multiple coalitions satisfying this property exist, CMES uniformly assigns $t$ to some coalition with the \textit{least} total budget. If such a coalition does not exist, then a new coalition $\{t\}$ is created. Each agent's payment can be determined similarly to the classical MES, though the algorithm remains unaffected by the spread of $n/\alpha$ among the agents. As agents pay $n/\alpha$ dollars in total for each agent assigned to an already existing coalition, CMES assigns at most $\alpha$ agents to each coalition. We now prove that:
\begin{theorem}
    \label{thm:cmes}
    The partition returned by CMES is CPJR.
\end{theorem}
\begin{proof}
    By contradiction, we assume that there are a coalition $C \in \mathcal{C}^n$, $m_C \in [\alpha]$ and an $m_C$-cohesive subgroup of agents $S_C \subseteq C$ such that $|\cup_{i \in S_C} F_i \cap C| \leq m_C-1$. At each time $t$ where agent $t$ is assigned to $C$, the agents within $S_C$ that approve $t$ pay exactly $n/\alpha$ dollars, and since $|\cup_{i \in S_C} F_i \cap C| \leq m_C-1$, they pay at most $(m_C-1) \cdot n/\alpha$ in total. Due to $|S_C| \geq m_C \cdot n/\alpha$, the agents within $S_C$ have at least $n/\alpha$ dollars at each time instant. Hence, at each time $t$ where $t \in \cap_{i \in S_C} F_i$, those agents have enough money for buying $t$. Thereby, each candidate in $\cap_{i \in S_C} F_i$ will be assigned to some existing coalition. There are \textit{at least} $m_C$ such agents. However, as $|\cup_{i \in S_C} F_i \cap C| \leq m_C-1$ there are \textit{at most} $m_C - 1$ such agents, which therefore constitutes a contradiction completing the proof.
\end{proof}

\subsubsection{Achieving CEJR.}
\label{sec:extended Justified Representation (EJR)}
% Namely, as it will be formally proven later, achieving $\eta$-CEJR is more challenging than PJR, and thus we next focus on scenarios \textit{without uncertainty} (i.e., friendships are revealed). Namely, at each time $t$ and for each agent $i \in [t]$, let $\mathcal{N}_i^t = \{C \subseteq [t] : i \in C\}$ be all possible coalitions containing agent $i$ and let $F_i$ be agent $i$'s friends in the social network. Thus, agent $t$ arrives along with $v_t^t$, where $v_i^t: \mathcal{N}_i^t \rightarrow \{0,1\}$ is the valuations of agent $i \in [t]$ to the agents \textit{who arrived until time $t$}. Her utility for a coalition $C \subseteq [t]$ is the number of her friends within $C$, i.e., $v_i(C) = |F_i \cap C|$. $\mathbf{v}^t = (v_i^t)_{i \in [t]}$ is the joint valuation of the agents \textit{who arrived until time $t$}.
%
We begin with an impossibility result which depicts that gaining $\eta$-CEJR is indeed much harder. Even when $\alpha$-bounded partitions can only contain a \textit{single} coalition, our problem can be viewed as a special case of online approval committee elections \cite{do2022online}, where the single coalition generated by an online algorithm constitutes the winning committee. Letting $H(\alpha)$ be the $\alpha$-th harmonic number (i.e., $H(\alpha) = \sum_{j=1}^\alpha 1/j$), by Do et al. \shortcite[Theorem 5.3]{do2022online} we thus infer the following lower bound:
\begin{corollary}
    \label{corollary:lower bound}
    There exists no deterministic online algorithm that generates a $(1-\varepsilon) H(\alpha)$-CEJR partition for any $\varepsilon > 0$.
\end{corollary}
%

Adapting the algorithm in \cite[Section 5.2]{do2022online} for committee elections, we next provide the optimal \textit{Greedy Coalitionally Cohesive} (\textbf{GCC}) scheme, i.e., GCC satisfies $H(\alpha)$-CEJR. Informally, GCC assigns each agent $i$ to a coalition containing a sufficiently large number of agents that are friends of $i$. At time $t$, if there exists a coalition $C \in \mathcal{C}^t$ and $S \subseteq C$ with $S \subseteq N_t^t$ and $|S| \geq H(\alpha) \cdot m \cdot n/\alpha$ s.t. each agent in $S$ is a neighbor of less than $m$ agents assigned to $C$ thus far, then GCC assigns $t$ to $C$. If multiple such coalitions exist, GCC uniformly assigns $t$ to the coalition of \textit{smallest} cardinality. If such a coalition does not exist, then a new coalition $\{t\}$ is created. We now prove that: %the resulting partition $\mathcal{C}^n$ satisfies $H(\alpha)$-CEJR.
\begin{theorem}
    \label{thm:gcc}
    The partition returned by GCC is $H(\alpha)$-CEJR and each coalition contains at most $\alpha$ agents.
\end{theorem}
\begin{proof}
    (\textit{Sketch})
    By construction, the partition is $H(\alpha)$-CEJR. Using a budgeting argument, we prove in Appendix J that each coalition contains at most $\alpha$ agents. %Each agent $t$ is associated with a price of $n/\alpha$. When GCC assigns $t$ to a coalition $C \in \mathcal{C}^t$, her price is spread equally among the agents approving $t$. Note that for each $m \in [\alpha]$ each agent buys at most $m$ agent, thus forming an $(H(\alpha), m)$-cohesive coalition. Then, $|N_t^t| \geq H(\alpha) \cdot m \cdot n/\alpha$ for any such agent $t$. For $m=1$, each agent pays at most $n/\alpha \cdot 1/(H(\alpha) n/\alpha) = 1/H(\alpha)$. For $m=2$, each agent $i$ buys at most two agents forming an $(H(\alpha), 2)$-cohesive coalition. One agent could have been bought earlier when $m=1$ and for which $i$ paid $1/H(\alpha)$. For the second agent, agent $i$ pays at most $m/\alpha \cdot 1/(H(\alpha) \cdot 2 \cdot n/\alpha) = 1/(2H(\alpha))$. Inductively, we obtain that each agent pays at most $\sum_{m=1}^\alpha 1/(m H(\alpha)) = 1$, i.e., the total amount of money paid is at most $n$. Since each agent costs $n/\alpha$, then GCC assigns at most $\alpha$ agent to each coalition.
\end{proof}

Next, we further illuminate on the complexity of obtaining a partition satisfying $\eta$-CEJR. We remark that GCC requires checking whether a coalition is $(\eta, m)$-cohesive, where verifying its existence is generally NP-hard. The proof in Appendix K is by reduction from Maximum $k$-Subset Intersection \cite{xavier2012note}.
\begin{theorem}
    \label{thm:cohesive np hard}
    Checking whether there exists an $m$-cohesive coalition is NP-hard.
\end{theorem}
%\begin{proof}
    %(\textit{Sketch}) %, where we are given a collection $\mathcal{S} = \{S_j\}_{j \in [x]}$ of $x$ subsets over a set of $y$ elements $\mathcal{E} = \{e_i\}_{i \in [y]}$, and two positive integers $\lambda,m$. The goal is deciding whether there exists a subcollection $\{S_{j_\xi}\}_{\xi \in [\lambda]}$ of $\lambda$ sets from $\mathcal{S}$ such that $|\cap_{\xi \in [\lambda]} S_{j_\xi}| \geq m$. Given an instance of MSI, we construct an hedonic game with $n = x+y$ agents, where each set in $S_j \in \mathcal{S}$ is associated with an agent $S_j$ and each element $e_i \in \mathcal{E}$ is associated with an agent $e_i$. A set agent $S_j$ approves any element agent $e_i \in S_j$, whereas an element agent $e_i$ approves any set agent $S_j$ with $e_i \in S_j$ and each other element agent within $S_j$. Let $\alpha = y n/\lambda$. For every $\lambda$ sets $\{S_{j_\xi}\}_{\xi \in [\lambda]}$, $|\cap_{\xi \in [\lambda]} S_{j_\xi}|$ is the largest set of element agents approved by all the set agents $\{S_{j_\xi}\}_{\xi \in [\lambda]}$. Thus, there exists a solution $\{S_{j_\xi}\}_{\xi \in [\lambda]}$ to the MSI instance if and only if the set agents $C = \{S_{j_\xi}\}_{\xi \in [\lambda]}$ satisfy $|C| = \lambda \geq m \cdot n/\alpha$ and $|\cap_{\xi \in [\lambda]} S_{j_\xi}| \geq m$, i.e., $C$ is an $m$-cohesive coalition.
%\end{proof}

Theorem \ref{thm:cohesive np hard} dictates that GCC cannot be executed in polynomial time, and thus achieving an \textit{optimal} partition as stated by Corollary \ref{corollary:lower bound} is challenging. Hence, we supply \textit{Sub-Coalitions by Greedy Budgeting} (\textbf{SCGB}), a polynomial-time algorithm that yields a slightly worse CEJR guarantee than GCC. Our scheme adapts the algorithm in \cite[Section 5.3]{do2022online} for committee elections to hedonic games. First, let $w(\cdot)$ be the inverse function of $x \mapsto x^x$, i.e., $w(\alpha) = x$ if $\alpha = x^x$. Note that $w(\alpha) = O(\log \alpha)$ and $\log \alpha = O(w(\alpha)^2)$. Let $\beta = \lceil w(\alpha) \rceil$. SCGB independently creates $\beta$ sub-coalitions generated similarly to CMES, each of size $\lfloor \alpha/\beta \rfloor$. Formally, each agent is given an initial budget of $(1, \dots, 1) \in [0,1]^\beta$, i.e., there are $\beta$ independent dollars where each one is associated with a specific possible sub-coalition. The $j^{th}$ coin can be used for buying agents who are approved by at least $n \beta^j /\alpha$. Each agent costs $n \beta/\alpha$ dollars. At time $t$, we find the largest triple $j \in [\beta]$ and a coalition $C \in \mathcal{C}^t$ with $S \subseteq C$ satisfying $S \subseteq N_t^t$ (we first maximize over $j$ and then over $|S|$), s.t. $|S| \geq n \beta^j /\alpha$ and each agent in $S$ has at least $n\beta /(\alpha |S|)$ dollars of type $j$ left. That is, those agents can afford to buy agent $t$ assuming that each of them pays the same amount of money using the coins of type $j$. If such a triple $(j,C,S)$ exists, then SCGB assigns $t$ to $C$. If multiple such triples exist, SCGB uniformly assigns $t$ to some coalition with the \textit{least} total budget of type $j$. In both cases, each agent in $S$ pays $n\beta /(\alpha |S|)$ dollars for $t$. If such a triple does not exist, then a new coalition $\{t\}$ is created. As each agent has $\beta$ dollars in total, then buying each agent costs $n \beta/\alpha$ dollars and thus SCGB assigns at most $\alpha$ agents to each coalition. In Appendix L, we show that: % to what extent SCGB approximates CEJR:
\begin{theorem}
    \label{thm:scgb}
    SCGB returns a $\lceil w(\alpha) \rceil^2$-CEJR partition.
\end{theorem}
% \begin{proof}
%     By contradiction, assume that there are a coalition $C \in \mathcal{C}^n$, $m_C \in [\alpha]$ and an $(\beta^2, m)$-cohesive subgroup of agents $S_C \subseteq C$ with $|S_C| \geq \beta^2 m_C n/\alpha$ and $|\cap_{i \in S_C} F_i| \geq m_C$ such that for each agent $i \in S_C$ we have $|F_i \cap C| < m_C$. There exists $j_C \in [\beta]$ such that $n \beta^{j_C} /\alpha \leq |S_C| \leq n \beta^{j_C+1} /\alpha$, and thus $m_C \leq \beta^{j_C-1}$. Let $S_C^{j_C}$ be the $j_C$-th sub-coalition associated with $C$. For each agent in $S_C^{j_C}$ a single agent pays at most: $\frac{n \beta}{\alpha}/(\frac{n \beta^{j_C}}{\alpha}) = 1/\beta^{j_C-1} \leq 1/m_C$. Since $|F_i \cap C| < m_C$ for each $i \in S_C$, each agent in $S_C$ approves at most $m_C-1$ agent in $S_C^{j_C}$, yielding that each agent paid at most $(m_C-1)/m_C$ dollars and her remaining budget is at least $1/m_C \geq 1/\beta^{j_C-1}$. Hence, when an agent in $\cap_{i \in S_C} F_i \setminus S_C^{j_C}$ arrives, there are at least $|S_C| \geq n \beta^{j_C}/\alpha$ agents, each with at least $1/\beta^{j_C-1}$ dollars of type $j_C$ left. Their total budget is sufficient for buying that agent since $|S_C|/\beta^{j_C-1} \geq n \beta^{j_C}/\alpha \cdot 1/\beta^{j_C-1} = n \beta/\alpha$. Since the above reasoning holds for each coalition $C \in \mathcal{C}^n$, then each agent within $\cap_{i \in \mathcal{S_C}} F_i$ will eventually be assigned to some coalition. There are at \textit{least} $m_C$ such agents. However, as $|F_i \cap C| \leq m_C-1$ for each $i \in S_C$, there should be at \textit{most} $ m_C-1$ such agents, which constitutes a contradiction that completes the proof.
% \end{proof}

\subsection{Proportionality under Uncertainty}
\label{sec:Proportionality under Uncertainty}
Surprisingly, when friendships are \textit{uncertain}, our MPCF algorithm is also \textit{optimal} for guaranteeing CEJR and CPJR in the CLV model. That is, the probability that the partition produced by MPCF satisfies CEJR (CPJR) \textit{dominates} the probability that the partition generated by \textit{any} other algorithm $\mathcal{A}$ satisfies CEJR (CPJR). The proof in Appendix I stems from minor modifications of the proof for Theorem \ref{thm:MPCF is optimal}.
\begin{theorem}
    \label{thm:MPCF is optimal for CEJR}
    Under the CLV model, let $\mathbf{p} \in [0,1]^n$ be a weight vector and let $\mathcal{A}$ be an online algorithm for our problem. Then, $\mathbb{P}[\mathcal{A}(G_{\mathbf{p}}) \text{ is CEJR}] \leq \mathbb{P}[\mathcal{A}^\star(G_{\mathbf{p}}) \text{ is CEJR}]$. In fact, $\mathbb{P}[\mathcal{A}(G_{\mathbf{p}}) \text{ is CPJR}] \leq \mathbb{P}[\mathcal{A}^\star(G_{\mathbf{p}}) \text{ is CPJR}]$.
\end{theorem}

\begin{corollary}
    \label{coro:optimal}
    \textbf{Under the CLV model, MPCF is {\normalfont \textbf{optimal}} in terms of {\normalfont \textbf{both}} social welfare and proportionality.}
\end{corollary}

Our strong positive result does not generalize to cases where friendships are revealed. In such settings, though MPCF is almost optimal in terms of social welfare by Remark \ref{remark:competitive analysis}, the following example shows that the partition produced by MPCF does \textit{not} necessarily satisfy CPJR or CEJR:
% When friendships are revealed, MPCF is almost optimal in terms of social welfare by Remark \ref{remark:competitive analysis}, but . The following example shows that the partition produced by MPCF does \textit{not} always satisfy CPJR or CEJR:
\begin{example}
    \label{example:not CPJR}
    Our example is inspired by \cite[Theorem 3]{aziz2017justified}. For $\alpha \geq 3$, consider that $n=\alpha+1$, agent $\alpha+1$ is the only friend of agent $1$ and the agents $2, \dots, \alpha$ are all friends with each other. Then, MPCF will return the partition $\mathcal{C} = ([\alpha])$ consisting of a single coalition. Note that $\{1\}$ is a $1$-cohesive coalition, yet $v_i(C) = 0$, and thus yielding that the partition $\mathcal{C}$ is neither CPJR nor CEJR.
\end{example}


% \subsection{Core Stability (CS)}
% \label{sec:Core Stability}
% In this section, we consider the main stability notion of cooperative game theory, the \textit{core}, that has been further applied to the settings of elections for studying proportionality \cite{aziz2017justified}. Informally, a partition is in the core if no coalition of agents can deviate to another coalition for increasing their utility. Namely, we define an approximation of core stability in a sense similar to \cite{peters2020proportionality}:
% \begin{definition}
%     \label{def:core}
%     {\normalfont (CS)}
%     Given $\eta \geq 1$, the partition $\mathcal{C}^t$ at time $t$ is {\normalfont $\eta$-core-stable} ($\eta$-CS) if for each coalition $C \in \mathcal{C}^t$ it holds that for any pair of coalitions $S \subseteq C$ and $V \subseteq N$ with $S \subseteq V$ and $|V| / n \leq |S| / \alpha$, there is an agent $i \in S$ with $|F_i \cap V| > \max(\eta \cdot |F_i \cap C|,1)$. $\mathcal{C}^t$ is {\normalfont core-stable} if the last inequality is substituted with $|F_i \cap V| \geq |F_i \cap C|$.
% \end{definition}

% As CS implies EJR in the committee elections setting \cite{brill2022individual}, then it is a stronger axiom than both EJR and PJR. We also note that a lower value of $\eta$ corresponds to \textit{stronger} stability guarantees. Moreover, $\max(\eta \cdot |F_i \cap C|,1)$ is used instead of simply $\eta \cdot |F_i \cap C|$ since if $|F_i \cap C| = 0$ then all values of $\eta$ enforce the same (weak) constraint on each agent's utility. Next, we prove that the CMES scheme presented in Subsection \ref{sec:Proportional Justified Representation (PJR)} supplies a logarithmic approximation of the core.
% \begin{theorem}
%     \label{thm:core}
%     CMES returns a $O(\log \alpha)$-CS partition.
% \end{theorem}
% \begin{proof}
%     (\textit{Sketch}) Let $\beta := 1/(2 \log(2 \alpha))$. In Appendix \ref{supp:The Coalitional Method of Equal Shares Provides a Logarithmic Approximation of the Core}, we assume by contradiction that CMES is \textit{not} $1/(4 \log(2 \alpha) + 1)$-CS and derive that $\beta > 1/(2 \log(2 \alpha))$, which constitutes a contradiction yielding that CMES is $O(\log \alpha)$-CS.
% \end{proof}

\section{Conclusions and Future Work}
\label{sec:Conclusions and Future Work}
We have explored an online variant of partitioning agents in an undirected social network into coalitions of a bounded size. Initially, we gave the first results for maximizing social welfare in online hedonic games where algorithms have access to (possibly machine-learned) predictions, capturing uncertainty. Our work also initiated the study of lifting proportionality axioms from elections to hedonic games. We first analyzed the notions of CPJR and CEJR in scenarios where friendships are revealed. When friendships are \textit{uncertain}, our MPCF algorithm is \textit{optimal} in terms of \textit{both} social welfare and proportionality for a vast family of natural random graphs. Our results can be seen as evidence that %an online algorithm with access to predictions can attain a better guarantee than scenarios \textit{without predictions}, and
predictions are a promising tool for improving algorithms in online hedonic games, even if predictions are slightly noisy. %Even when friendships are \textit{uncertain}, we were capable of designing the MPCF algorithm that is \textit{optimal} in terms of \textit{both} social welfare and proportionality for a vast family of natural random graphs. When friendships are \textit{certain} this may not be the case, so we devised a polynomial algorithm, called CMES, that achieves CPJR. However, the stronger axiom CEJR can only be \textit{approximated}. As its best possible approximation is computationally hard to attain, we developed a polynomial-time scheme that satisfies a slightly worse CEJR guarantee.
%

Our work opens the way for many future studies. Immediate directions are exploring other classes of hedonic games in online settings and studying proportionality in general uncertain domains. It is also appealing to examine scenarios where assignments may be postponed, agents may be reassigned after each arrival, or both.


We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
We consider a multi-level jury problem in which experts
\clearpage
\bibliography{aaai24}

\end{document}